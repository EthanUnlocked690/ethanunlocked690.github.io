<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Nexus</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU29jaWFsIE5leHVzIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJzdGFydF91cmwiOiIuIiwiaWNvbnMiOltdfQ==">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --primary: #6366f1;
            --primary-light: #818cf8;
            --success: #10b981;
            --danger: #ef4444;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body, html { height:100%; width:100%; overflow:hidden; font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); }
        body { display:flex; flex-direction:column; }

        /* Login */
        #login {
            flex:1; display:flex; align-items:center; justify-content:center; padding:2rem;
            background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
        }
        #login form { width:100%; max-width:340px; display:flex; flex-direction:column; gap:1.5rem; }
        #login h1 { font-size:2rem; font-weight:700; text-align:center; margin-bottom:1rem; color:white; }
        #login input {
            padding:1rem 1.25rem; border:none; border-radius:var(--radius); background:var(--surface); color:var(--text);
            font-size:1.1rem; transition:all 0.2s;
        }
        #login input:focus { outline:none; background:#334155; box-shadow:0 0 0 3px rgba(99,102,241,0.3); }
        #login button {
            padding:1rem; background:linear-gradient(45deg,var(--primary),var(--primary-light));
            border:none; border-radius:var(--radius); color:white; font-weight:600; font-size:1.1rem;
            cursor:pointer; transition:transform 0.2s;
        }
        #login button:active { transform:scale(0.97); }

        /* App */
        #app { display:none; flex-direction:column; height:100vh; background:var(--bg); }

        /* Header */
        #chatHeader {
            padding:1rem 1.25rem; background:var(--surface); border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:1rem; position:relative;
        }
        #backBtn {
            width:44px; height:44px; background:var(--bg); border:none; border-radius:50%;
            color:var(--text); font-size:1.3rem; cursor:pointer; display:flex; align-items:center; justify-content:center;
        }
        #backBtn:active { transform:scale(0.9); }
        .chat-user { display:flex; align-items:center; gap:0.75rem; flex:1; }
        .avatar {
            width:48px; height:48px; background:var(--primary); border-radius:50%; display:flex;
            align-items:center; justify-content:center; font-weight:700; color:white; font-size:1.1rem;
        }
        .chat-info h3 { font-size:1.1rem; font-weight:600; }
        .chat-info p { font-size:0.85rem; color:var(--text-muted); }
        .header-actions { display:flex; gap:0.5rem; }
        .header-actions button {
            width:44px; height:44px; background:var(--bg); border:none; border-radius:50%;
            color:var(--text); font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center;
        }
        .header-actions button:active { transform:scale(0.9); }

        /* Messages */
        #messages {
            flex:1; overflow-y:auto; padding:1rem 1.25rem; display:flex; flex-direction:column; gap:0.75rem;
            -webkit-overflow-scrolling:touch;
        }
        .message {
            max-width:78%; padding:0.9rem 1.1rem; border-radius:18px; line-height:1.5;
            font-size:1rem; word-wrap:break-word; position:relative;
        }
        .message.sent { align-self:flex-end; background:var(--primary); color:white; border-bottom-right-radius:4px; }
        .message.received { align-self:flex-start; background:var(--surface); color:var(--text); border-bottom-left-radius:4px; }
        .message-time { font-size:0.7rem; opacity:0.7; margin-top:0.25rem; text-align:right; }

        /* Input */
        #chatInput {
            padding:0.75rem 1rem; background:var(--surface); border-top:1px solid var(--border);
            display:flex; align-items:center; gap:0.75rem;
        }
        #messageInput {
            flex:1; padding:0.9rem 1.2rem; border:none; border-radius:28px; background:var(--bg);
            color:var(--text); font-size:1.05rem;
        }
        #messageInput:focus { outline:none; background:#334155; }
        .input-btn {
            width:48px; height:48px; background:var(--bg); border:none; border-radius:50%;
            color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center;
            font-size:1.2rem;
        }
        .input-btn:active { transform:scale(0.9); }
        #sendBtn { background:var(--success); color:white; font-size:1.3rem; }

        /* Bottom Nav */
        #bottomNav {
            height:70px; background:var(--surface); border-top:1px solid var(--border);
            display:flex; justify-content:space-around; align-items:center;
            padding-bottom:env(safe-area-inset-bottom);
        }
        .nav-btn {
            width:60px; height:60px; background:transparent; border:none; color:var(--text-muted);
            display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
            font-size:1.4rem; cursor:pointer; transition:all 0.2s;
        }
        .nav-btn.active { color:var(--primary); }
        .nav-btn:active { transform:scale(0.9); }
        .nav-label { font-size:0.7rem; font-weight:500; }

        /* Sidebar */
        #sidebar {
            position:fixed; bottom:0; left:0; right:0; height:75vh; background:var(--surface);
            border-top-left-radius:24px; border-top-right-radius:24px; box-shadow:var(--shadow);
            transform:translateY(100%); transition:transform 0.35s cubic-bezier(0.32,0.72,0,1); z-index:100;
            display:flex; flex-direction:column; padding:1.5rem 1rem 1rem;
        }
        #sidebar.open { transform:translateY(0); }
        #sidebar h3 { margin:0 0 1rem; font-size:1.2rem; color:var(--primary); text-align:center; }
        #userList { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:0.75rem; }
        .user-item {
            padding:1rem; background:var(--bg); border-radius:var(--radius); cursor:pointer;
            display:flex; justify-content:space-between; align-items:center; transition:all 0.2s;
            border:2px solid transparent;
        }
        .user-item:active { transform:scale(0.97); }
        .user-item.selected { border-color:var(--primary); background:rgba(99,102,241,0.15); }
        .user-info { display:flex; flex-direction:column; gap:0.25rem; flex:1; }
        .user-name { font-weight:600; font-size:1.05rem; }
        .user-status { font-size:0.8rem; color:var(--text-muted); display:flex; align-items:center; gap:0.5rem; }
        .status-dot { width:8px; height:8px; border-radius:50%; }
        .online { background:var(--success); }
        .offline { background:#64748b; }
        .unread-badge {
            background:var(--danger); color:white; font-size:0.7rem; font-weight:bold;
            padding:2px 6px; border-radius:10px; min-width:18px; text-align:center;
        }
        .user-actions {
            display:flex; gap:0.5rem;
        }
        .action-btn {
            width:40px; height:40px; background:var(--bg); border:none; border-radius:50%;
            color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center;
            font-size:1.1rem;
        }
        .action-btn:active { transform:scale(0.9); }
        .action-msg { color:var(--success); }
        .action-call { color:var(--primary); }

        /* Call Controls */
        #callControls {
            padding:1rem; background:var(--surface); border-top:1px solid var(--border);
            display:flex; gap:1rem; justify-content:center; flex-wrap:wrap;
        }
        #callControls button {
            padding:0.75rem 1.25rem; border:none; border-radius:20px; color:white;
            font-weight:600; font-size:0.95rem; cursor:pointer; display:flex; align-items:center; gap:0.5rem;
        }
        #callBtn { background:var(--primary); }
        #endCallBtn { background:var(--danger); }
        #micBtn { background:var(--success); }
        #camBtn { background:#f59e0b; }
        #screenBtn { background:#8b5cf6; }

        /* Toast */
        #notificationToast {
            position:fixed; bottom:90px; left:50%; transform:translateX(-50%);
            background:rgba(0,0,0,0.9); color:white; padding:1rem 1.5rem; border-radius:16px;
            box-shadow:var(--shadow); display:flex; align-items:center; gap:1rem; z-index:1000;
            opacity:0; transition:all 0.3s; max-width:90%; backdrop-filter:blur(12px);
        }
        #notificationToast.show { opacity:1; }

        /* Hidden */
        input[type="file"] { display:none; }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
    <form id="loginForm">
        <h1>Social Nexus</h1>
        <input type="text" id="username" placeholder="Username" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">Login</button>
    </form>
</div>

<!-- APP -->
<div id="app">
    <header id="chatHeader">
        <button id="backBtn">Back</button>
        <div class="chat-user">
            <div class="avatar" id="chatAvatar">?</div>
            <div class="chat-info">
                <h3 id="chatWith">Select a user</h3>
                <p id="chatStatus">—</p>
            </div>
        </div>
        <div class="header-actions">
            <button id="headerMsgBtn">Message</button>
            <button id="headerCallBtn">Phone</button>
        </div>
    </header>

    <section id="messages"></section>

    <div id="chatInput">
        <button class="input-btn" id="attachBtn">Attach</button>
        <input type="text" id="messageInput" placeholder="Type a message..." disabled>
        <button class="input-btn" id="sendBtn" disabled>Send</button>
        <input type="file" id="fileInput" multiple>
    </div>

    <div id="callControls" style="display:none;">
        <button id="callBtn">Call</button>
        <button id="endCallBtn" style="display:none;">End</button>
        <button id="micBtn">Mic</button>
        <button id="camBtn">Cam</button>
    </div>

    <!-- Bottom Nav -->
    <nav id="bottomNav">
        <button class="nav-btn active" id="navChat">
            <div>Chat</div>
            <div class="nav-label">Chat</div>
        </button>
        <button class="nav-btn" id="navUsers">
            <div>Users</div>
            <div class="nav-label">Users</div>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside id="sidebar">
        <h3>Online Users</h3>
        <ul id="userList"></ul>
    </aside>
</div>

<!-- Toast -->
<div id="notificationToast">
    <div>New Message</div>
    <div id="notifBody">You have a new message.</div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    class SocialNexus {
        constructor() {
            this.users = { 'Alice': '123', 'Bob': '456', 'Charlie': '789' };
            this.currentUser = null;
            this.peer = null;
            this.connections = {};
            this.currentPeerId = null;
            this.messageHistory = {};
            this.unreadCounts = {};

            this.init();
        }

        init() {
            this.bindEvents();
        }

        bindEvents() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', e => {
                e.preventDefault();
                const u = document.getElementById('username').value.trim();
                const p = document.getElementById('password').value.trim();
                if (this.users[u] && this.users[u] === p) {
                    this.currentUser = u;
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    this.setupPeer();
                    this.populateUserList();
                } else {
                    alert('Invalid credentials');
                }
            });

            // Chat
            document.getElementById('sendBtn').onclick = () => this.sendMessage();
            document.getElementById('messageInput').oninput = () => this.handleTyping();
            document.getElementById('backBtn').onclick = () => this.closeChat();
            document.getElementById('navChat').onclick = () => this.closeSidebar();
            document.getElementById('navUsers').onclick = () => this.openSidebar();
            document.getElementById('attachBtn').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('headerMsgBtn').onclick = () => document.getElementById('messageInput').focus();
            document.getElementById('headerCallBtn').onclick = () => this.startCall();
        }

        setupPeer() {
            this.peer = new Peer(this.currentUser);
            this.peer.on('open', () => {
                console.log('Peer open:', this.currentUser);
            });

            this.peer.on('connection', conn => {
                this.connections[conn.peer] = conn;
                this.updateUserStatus(conn.peer, true);
                conn.on('data', data => this.handleData(conn.peer, data));
                conn.on('close', () => {
                    delete this.connections[conn.peer];
                    this.updateUserStatus(conn.peer, false);
                });
            });
        }

        populateUserList() {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            Object.keys(this.users).filter(u => u !== this.currentUser).forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-item';
                li.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${user}</div>
                        <div class="user-status">
                            <div class="status-dot offline" id="dot-${user}"></div>
                            <span>Offline</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <span class="unread-badge" id="badge-${user}" style="display:none;">0</span>
                        <div class="user-actions">
                            <button class="action-btn action-msg" data-user="${user}">Message</button>
                            <button class="action-btn action-call" data-user="${user}">Phone</button>
                        </div>
                    </div>
                `;
                li.onclick = () => this.selectUser(user);
                li.querySelector('.action-msg').onclick = (e) => {
                    e.stopPropagation();
                    this.selectUser(user);
                };
                li.querySelector('.action-call').onclick = (e) => {
                    e.stopPropagation();
                    this.selectUser(user, 'call');
                };
                list.appendChild(li);
            });
        }

        selectUser(user, action = 'chat') {
            this.currentPeerId = user;
            document.querySelectorAll('.user-item').forEach(i => i.classList.remove('selected'));
            const item = [...document.querySelectorAll('.user-item')].find(el => el.querySelector('.user-name').textContent === user);
            if (item) item.classList.add('selected');

            document.getElementById('chatWith').textContent = user;
            document.getElementById('chatAvatar').textContent = user[0];
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            this.unreadCounts[user] = 0;
            this.updateBadge(user, 0);
            this.loadMessages(user);
            this.closeSidebar();

            if (action === 'call') setTimeout(() => this.startCall(), 300);
            else setTimeout(() => document.getElementById('messageInput').focus(), 100);
        }

        closeChat() {
            this.currentPeerId = null;
            document.getElementById('chatWith').textContent = 'Select a user';
            document.getElementById('chatAvatar').textContent = '?';
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            this.closeSidebar();
        }

        openSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('navUsers').classList.add('active');
        }

        closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('navChat').classList.add('active');
        }

        sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !this.currentPeerId) return;

            const msg = { type: 'message', text, from: this.currentUser, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) };
            this.addMessage(text, true, msg.time);
            this.saveMessage(this.currentPeerId, msg, true);

            const conn = this.connections[this.currentPeerId] || this.peer.connect(this.currentPeerId);
            if (conn.open) conn.send(msg);
            this.connections[this.currentPeerId] = conn;

            input.value = '';
        }

        handleData(peerId, data) {
            if (data.type === 'message') {
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                this.addMessage(data.text, false, time);
                this.saveMessage(peerId, data, false);
                if (document.hidden || this.currentPeerId !== peerId) {
                    this.unreadCounts[peerId] = (this.unreadCounts[peerId] || 0) + 1;
                    this.updateBadge(peerId, this.unreadCounts[peerId]);
                }
            }
        }

        addMessage(text, sent, time) {
            const div = document.createElement('div');
            div.className = `message ${sent ? 'sent' : 'received'}`;
            div.innerHTML = `${text}<div class="message-time">${time}</div>`;
            document.getElementById('messages').appendChild(div);
            this.scrollToBottom();
        }

        saveMessage(peerId, data, sent) {
            if (!this.messageHistory[peerId]) this.messageHistory[peerId] = [];
            this.messageHistory[peerId].push({ ...data, sent });
        }

        loadMessages(peerId) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            (this.messageHistory[peerId] || []).forEach(m => {
                this.addMessage(m.text, m.sent, m.time || '');
            });
        }

        updateBadge(user, count) {
            const badge = document.getElementById(`badge-${user}`);
            if (badge) {
                badge.style.display = count > 0 ? 'block' : 'none';
                badge.textContent = count > 99 ? '99+' : count;
            }
        }

        updateUserStatus(user, online) {
            const dot = document.getElementById(`dot-${user}`);
            if (dot) {
                dot.className = `status-dot ${online ? 'online' : 'offline'}`;
                dot.nextElementSibling.textContent = online ? 'Online' : 'Offline';
            }
        }

        scrollToBottom() {
            const el = document.getElementById('messages');
            el.scrollTop = el.scrollHeight;
        }

        startCall() {
            alert('Call feature coming soon!');
        }
    }

    new SocialNexus();
</script>
</body>
</html>
