<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ATLAS: Ultimate SIM-HACK LAB — Local Only (with Challenges & Macros)</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#020207; --panel:#071014; --accent:#00ff66; --muted:#7f9aa0; --danger:#ff4d6d;
    --glass: rgba(255,255,255,0.02);
    --mono: "Inconsolata", monospace;
    --ui: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    --radius:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(ellipse at center,#001 0%,#000 60%); color:#cfe; font-family:var(--ui);}
  .app {
    display:grid;
    grid-template-columns: 260px 1fr 420px;
    gap:16px;
    padding:18px;
    min-height:100vh;
  }
  header.top {
    grid-column: 1 / -1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px 18px;
    border-radius:10px;
    background:linear-gradient(90deg, rgba(0,255,102,0.03), rgba(0,170,255,0.02));
    border:1px solid rgba(255,255,255,0.03);
  }
  .brand { font-family: var(--mono); font-weight:700; color:var(--accent); font-size:1.05rem; }
  .subtitle { color:var(--muted); font-size:0.9rem; }
  .panel { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); }
  /* LEFT (targets + challenges) */
  .left { display:flex; flex-direction:column; gap:10px; }
  .targets { display:flex; flex-direction:column; gap:8px; margin-top:8px; max-height:28vh; overflow:auto; }
  .target { display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; background:var(--glass); cursor:pointer; }
  .target.selected { outline:2px solid rgba(0,255,102,0.12); box-shadow:0 6px 18px rgba(0,255,102,0.04); }
  .controls { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .small { font-size:12px; color:var(--muted); }
  .challenge { padding:8px; margin-bottom:6px; border-radius:6px; background:rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center; }
  .challenge .meta { max-width:160px; }
  .badge { font-size:11px; padding:4px 6px; border-radius:6px; background:rgba(255,255,255,0.02); color:var(--muted); }
  /* CENTER (terminal & tools) */
  .center { display:flex; flex-direction:column; gap:10px; }
  .terminal { height:50vh; background:#04060a; border-radius:8px; padding:12px; overflow:auto; font-family:var(--mono); font-size:13px; line-height:1.35; border:1px solid rgba(255,255,255,0.02); }
  .terminal .line { white-space:pre-wrap; margin:6px 0; }
  .terminal .time { color:var(--muted); margin-right:8px; }
  .cmdbar { display:flex; gap:8px; margin-top:8px; align-items:center; }
  input[type="text"], textarea { flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:inherit; font-family:var(--mono); }
  /* RIGHT (inspector & file library) */
  .right { display:flex; flex-direction:column; gap:10px; }
  .preview { padding:10px; border-radius:8px; background:rgba(0,0,0,0.2); min-height:80px; color:#e6ffe8; }
  .files { display:grid; grid-template-columns:1fr; gap:8px; max-height:36vh; overflow:auto; padding-top:6px; }
  .file-item { display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; background:var(--glass); }
  .tag { font-size:11px; padding:4px 6px; border-radius:6px; background:rgba(255,255,255,0.03); color:var(--muted); }
  /* matrix canvas */
  #matrix { position:fixed; inset:0; z-index:0; opacity:0.08; pointer-events:none; }
  /* macros UI */
  .macros { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .macro-item { padding:6px;border-radius:6px;background:rgba(255,255,255,0.01);display:flex;align-items:center;gap:6px; }
  /* responsive */
  @media (max-width:1100px) { .app { grid-template-columns: 1fr; } header.top { flex-direction:column; align-items:flex-start; } }
</style>
</head>
<body>
<canvas id="matrix" aria-hidden="true"></canvas>

<header class="top panel" role="banner">
  <div style="display:flex;gap:12px;align-items:center">
    <div class="brand">ATLAS — ULTIMATE SIM-HACK LAB</div>
    <div class="subtitle">Local, safe, cinematic — now with Challenges & Macros</div>
  </div>
  <div style="display:flex;gap:12px;align-items:center">
    <div class="small">Features: 67+ (local-only)</div>
    <button id="toggleMatrix" class="primary">Toggle Matrix</button>
    <button id="downloadBundle">Download Mega Sample Bundle</button>
  </div>
</header>

<div class="app" role="main" aria-live="polite">
  <!-- LEFT: Targets + Challenges -->
  <aside class="panel left" aria-label="Targets & Challenges">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Targets</strong>
      <div class="small">Local sims</div>
    </div>
    <div class="small">Choose a simulated target to explore.</div>
    <div id="targets" class="targets" role="list"></div>

    <div style="margin-top:8px"><strong>Challenges</strong></div>
    <div id="challenges" style="max-height:28vh; overflow:auto; margin-top:6px;"></div>

    <div style="margin-top:6px"><strong>Macros</strong></div>
    <div class="macros">
      <button id="btnMacroRecord">Start Recording (Ctrl+Shift+R)</button>
      <button id="btnMacroStop" disabled>Stop</button>
      <button id="btnMacroPlay">Play (Ctrl+Shift+P)</button>
    </div>
    <div id="macroList" style="margin-top:8px"></div>
    <div class="small" style="margin-top:8px">Hints reduce reward points when used.</div>
  </aside>

  <!-- CENTER: Terminal & Command UI -->
  <section class="panel center" aria-label="Terminal & Tools">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Terminal</strong>
      <div class="small">Local simulation — no network — safe</div>
    </div>

    <div id="terminal" class="terminal" role="log" tabindex="0"></div>

    <div class="cmdbar">
      <input id="cmd" type="text" placeholder='Enter command (type "help")' aria-label="Command input" autocomplete="off" />
      <button id="runCmd" class="primary">Run</button>
      <button id="clear">Clear</button>
      <select id="presetOps">
        <option value="">Presets</option>
        <option value="scan-all">Recon: Full Scan</option>
        <option value="deploy-sim">Ops: Sim Deploy</option>
        <option value="loot-export">Create Loot Files</option>
      </select>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <div class="small">Terminal speed:</div>
      <input id="speedRange" type="range" min="10" max="120" value="40" />
      <div class="small" id="speedVal">40 ms/char</div>
    </div>
  </section>

  <!-- RIGHT: Inspector & File Library -->
  <aside class="panel right" aria-label="Inspector & File Library">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Inspector</strong>
      <div class="small" id="selName">— none —</div>
    </div>

    <div class="preview" id="preview">Select a target to preview its homepage and metadata here.</div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <strong>File Library</strong>
      <div class="small">Local downloads</div>
    </div>
    <div class="files" id="files"></div>

    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="btnGenerateMany">Generate Lots of Files</button>
      <button id="btnExportSession">Export Session</button>
    </div>

    <div style="margin-top:8px" class="small">Docx/PDF downloads are simulated: they are text-wrapped blobs saved with .docx/.pdf extensions so you can practice handling downloaded artifacts. Do NOT use real secrets.</div>
  </aside>
</div>

<script>
/*
  Extended hack_super.html
  - Adds Challenge progression & level system with scoring & hints
  - Adds keyboard-driven macros recording & playback
  - Adds synthetic file type generation for .docx/.pdf (text-wrapped, local-only)
  - DOES NOT store or use any real external credentials. The username/password you shared will NOT be embedded here.
    If you want a simulated account named "Eternatus" you can create it via the UI; do not paste real credentials.
*/

/* Utilities */
const now = () => new Date().toISOString();
const elm = id => document.getElementById(id);
const add = (parent, tag='div', cls='') => { const e=document.createElement(tag); if(cls) e.className=cls; parent.appendChild(e); return e; };

/* State & persistence */
const STORAGE_KEY = 'atlas_super_v2';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
if(!state.targets) {
  state.targets = [
    { id:'site-1', name:'NOVA SHOP', url:'nova-shop.local', settings:{maintenance:false, homepage:'Welcome to Nova — deals!'}, accounts:[{user:'admin@nova', pass:'demo1', role:'ADMIN'}], logs:[] },
    { id:'site-2', name:'SKYCHAT', url:'skychat.local', settings:{maintenance:true, homepage:'SkyChat offline'}, accounts:[{user:'root@sky', pass:'root', role:'ROOT'}], logs:[] },
    { id:'site-3', name:'UNI LIBRARY', url:'lib.uni.local', settings:{maintenance:false, homepage:'Uni library'}, accounts:[], logs:[] }
  ];
}
state.cmdHistory = state.cmdHistory || [];
state.challenges = state.challenges || {}; // progress map
state.macros = state.macros || {}; // stored macros
state.downloadCount = state.downloadCount || 0;
localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

/* UI refs */
const targetsEl = elm('targets');
const terminalEl = elm('terminal');
const cmdInput = elm('cmd');
const runBtn = elm('runCmd');
const clearBtn = elm('clear');
const presetOps = elm('presetOps');
const preview = elm('preview');
const selName = elm('selName');
const filesEl = elm('files');
const speedRange = elm('speedRange');
const speedVal = elm('speedVal');
const challengesEl = elm('challenges');
const btnMacroRecord = elm('btnMacroRecord');
const btnMacroStop = elm('btnMacroStop');
const btnMacroPlay = elm('btnMacroPlay');
const macroListEl = elm('macroList');
const toggleMatrixBtn = elm('toggleMatrix');
const downloadBundleBtn = elm('downloadBundle');
const btnGenerateMany = elm('btnGenerateMany');
const btnExportSession = elm('btnExportSession');

/* Terminal typing */
let typingDelay = Number(speedRange.value || 40);
speedVal.textContent = `${typingDelay} ms/char`;
speedRange.addEventListener('input', ()=> { typingDelay = Number(speedRange.value); speedVal.textContent = typingDelay + ' ms/char'; });

function appendLine(text, cls=''){
  const container = document.createElement('div');
  container.className = 'line ' + cls;
  const t = document.createElement('span'); t.className='time'; t.textContent = `[${new Date().toLocaleTimeString()}] `;
  container.appendChild(t);
  terminalEl.appendChild(container);
  // typing animation
  let i=0;
  function step(){
    if(i < text.length){
      container.appendChild(document.createTextNode(text[i]));
      i++;
      terminalEl.scrollTop = terminalEl.scrollHeight;
      setTimeout(step, typingDelay);
    } else {
      container.appendChild(document.createElement('br'));
    }
  }
  step();
}

/* Targets */
let targets = state.targets;
let selected = null;
function renderTargets(){
  targetsEl.innerHTML = '';
  targets.forEach(t => {
    const div = document.createElement('div');
    div.className = 'target' + (selected && selected.id===t.id ? ' selected' : '');
    div.tabIndex = 0;
    div.innerHTML = `<div><strong>${t.name}</strong><div class="small">${t.url}</div></div><div class="badge">${t.settings.maintenance ? 'MAINT' : 'OK'}</div>`;
    div.addEventListener('click', ()=> selectTarget(t.id));
    targetsEl.appendChild(div);
  });
}
function selectTarget(id){
  selected = targets.find(t => t.id===id) || null;
  selName.textContent = selected ? selected.name : '— none —';
  preview.innerHTML = selected ? `<div style="font-weight:700">${selected.name} — ${selected.url}</div><div class="small" style="margin-top:6px;color:var(--muted)">${selected.settings.homepage}</div>` : 'Select a target';
  renderFiles();
  saveState();
  appendLine(`[UI] Selected ${selected ? selected.name : 'none'}`, 'info');
}

/* File library (samples + synthetic docx/pdf) */
const SAMPLE_FILES = [
  {name:'snippet.js', type:'code', content:'console.log(\"sample snippet\");'},
  {name:'example.py', type:'code', content:'print(\"hello world\")'},
  {name:'document.md', type:'doc', content:'# Demo Document\nThis is a demo.'},
  {name:'invoice.csv', type:'data', content:'id,amount\n1,99.99\n2,10.00'}
];

function renderFiles(){
  filesEl.innerHTML = '';
  SAMPLE_FILES.forEach(f => {
    const fi = document.createElement('div'); fi.className='file-item';
    fi.innerHTML = `<div><strong>${f.name}</strong><div class="small">${f.type}</div></div><div style="display:flex;gap:6px"><button class="download">DL</button><div class="tag">sample</div></div>`;
    fi.querySelector('.download').addEventListener('click', ()=> { triggerDownload(new Blob([f.content],{type:'text/plain'}), f.name); appendLine(`[files] Downloaded ${f.name}`, 'info'); incrementDownloads(); });
    filesEl.appendChild(fi);
  });
  if(selected){
    const projectBtn = document.createElement('div'); projectBtn.className='file-item';
    projectBtn.innerHTML = `<div><strong>${selected.id}-preview.txt</strong><div class="small">project</div></div><div style="display:flex;gap:6px"><button class="download">DL</button><div class="tag">preview</div></div>`;
    projectBtn.querySelector('.download').addEventListener('click', ()=> {
      const p = `Project preview for ${selected.name}\nSettings: ${JSON.stringify(selected.settings, null, 2)}`;
      triggerDownload(new Blob([p],{type:'text/plain'}), `${selected.id}-preview.txt`);
      appendLine(`[files] Downloaded project-preview for ${selected.name}`);
      incrementDownloads();
    });
    filesEl.appendChild(projectBtn);
  }
}

/* Simulated docx/pdf creation (plaintext-wrapped but with real file extensions) */
function generateDocx(name, text){
  const wrapper = `SIMULATED DOCX (TEXT WRAPPER)\n\n${text}\n\n-- End of simulated docx --`;
  triggerDownload(new Blob([wrapper], {type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'}), name.endsWith('.docx')?name:name+'.docx');
  appendLine(`[files] Generated simulated .docx: ${name}`, 'info'); incrementDownloads();
}
function generatePdf(name, text){
  const wrapper = `SIMULATED PDF (TEXT WRAPPER)\n\n${text}\n\n-- End of simulated pdf --`;
  triggerDownload(new Blob([wrapper], {type:'application/pdf'}), name.endsWith('.pdf')?name:name+'.pdf');
  appendLine(`[files] Generated simulated .pdf: ${name}`, 'info'); incrementDownloads();
}

/* Downloads count for challenge checks */
function incrementDownloads(){ state.downloadCount = (state.downloadCount || 0) + 1; saveState(); checkChallenges(); }

/* Trigger download helper */
function triggerDownload(blob, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
}

/* Challenges & Levels */
const CHALLENGE_DEFS = [
  { id:'c1', title:'First Contact', description:'Run the "list" command to view available targets.', hint:'Type "list" and press Enter.', points:10, check: (s)=> s.cmdHistory && s.cmdHistory.some(c => c.trim().toLowerCase().startsWith('list')) },
  { id:'c2', title:'Recon Novashop', description:'Run a fake-nmap scan (fake-nmap).', hint:'Type "fake-nmap" or use the button.', points:15, check: (s)=> s.cmdHistory && s.cmdHistory.some(c => c.trim().toLowerCase().includes('fake-nmap')) },
  { id:'c3', title:'Download Loot', description:'Download or generate at least 3 files from the file library.', hint:'Click some DL buttons or run generators. Counts downloads.', points:20, check: (s)=> (s.downloadCount || 0) >= 3 },
  { id:'c4', title:'Macro Master', description:'Record a macro of 3 commands and play it back.', hint:'Start recording (Ctrl+Shift+R), run commands, stop, then play (Ctrl+Shift+P).', points:25, check: (s)=> Object.values(s.macros || {}).some(m => m.commands && m.commands.length >=3 && m.lastPlayed && m.lastPlayed > 0) },
  // Add more challenge definitions here...
];

function ensureChallengeState(){
  state.challengeProgress = state.challengeProgress || {};
  for(const c of CHALLENGE_DEFS) if(!state.challengeProgress[c.id]) state.challengeProgress[c.id] = { completed:false, usedHint:false };
  saveState();
}
ensureChallengeState();

function renderChallenges(){
  challengesEl.innerHTML = '';
  for(const c of CHALLENGE_DEFS){
    const row = document.createElement('div'); row.className='challenge';
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `<div style="font-weight:700">${c.title}</div><div class="small">${c.description}</div>`;
    const right = document.createElement('div');
    const status = state.challengeProgress[c.id].completed ? `<div class="badge">Done</div>` : `<button class="hint-btn">Hint</button>`;
    right.innerHTML = `${status}<div class="small" style="text-align:right">${c.points} pts</div>`;
    row.appendChild(meta); row.appendChild(right);
    challengesEl.appendChild(row);
    if(!state.challengeProgress[c.id].completed){
      row.querySelector('.hint-btn').addEventListener('click', ()=> {
        // using a hint deducts points (mark used)
        if(!state.challengeProgress[c.id].usedHint){
          state.challengeProgress[c.id].usedHint = true;
          saveState();
          appendLine(`[HINT] ${c.hint}`, 'info');
          appendLine(`[HINT] Hint used — future reward for this challenge will be reduced.`, 'info');
        } else {
          appendLine('[HINT] Hint already used for this challenge.', 'info');
        }
      });
    }
  }
  renderScore();
}

function checkChallenges(){
  let changed=false;
  for(const c of CHALLENGE_DEFS){
    if(!state.challengeProgress[c.id].completed && c.check(state)){
      state.challengeProgress[c.id].completed = true;
      state.challengeProgress[c.id].completedAt = now();
      appendLine(`[CHALLENGE] Completed: ${c.title} (+${c.points} pts)`, 'info');
      changed=true;
    }
  }
  if(changed) { saveState(); renderChallenges(); }
}

function renderScore(){
  const total = CHALLENGE_DEFS.reduce((s,c)=>{
    const prog = state.challengeProgress[c.id];
    if(prog && prog.completed){
      const deduction = prog.usedHint ? Math.floor(c.points*0.4) : 0;
      return s + (c.points - deduction);
    }
    return s;
  }, 0);
  const max = CHALLENGE_DEFS.reduce((s,c)=>s+c.points,0);
  const scoreNode = document.createElement('div'); scoreNode.className='small'; scoreNode.textContent = `Score: ${total} / ${max}`;
  // place score at top of challenges panel
  const header = challengesEl.previousElementSibling;
  if(header) { header.querySelector('.score')?.remove(); header.appendChild(scoreNode).className='score'; }
}

/* Macros: record / stop / play */
let recording = false;
let currentMacro = null;
let macroIdCounter = Object.keys(state.macros || {}).length + 1;

function startMacroRecording(name){
  if(recording) return;
  recording = true;
  currentMacro = { id: 'macro-' + macroIdCounter++, name: name || `Macro ${macroIdCounter}`, start: now(), commands: [] };
  appendLine('[MACRO] Recording started: ' + currentMacro.name, 'info');
  btnMacroStop.disabled = false;
  btnMacroRecord.disabled = true;
}

function stopMacroRecording(){
  if(!recording) return;
  recording = false;
  currentMacro.end = now();
  state.macros[currentMacro.id] = currentMacro;
  saveState();
  appendLine('[MACRO] Recording stopped: ' + currentMacro.name, 'info');
  btnMacroStop.disabled = true;
  btnMacroRecord.disabled = false;
  renderMacroList();
}

function recordCommandToMacro(cmd){
  if(recording && currentMacro){
    currentMacro.commands.push({ cmd, t: Date.now() });
  }
}

function playMacro(id){
  const macro = state.macros[id];
  if(!macro) { appendLine('[MACRO] Not found', 'err'); return; }
  appendLine(`[MACRO] Playing: ${macro.name}`, 'info');
  // playback with preserved timing (approx)
  (async ()=>{
    let last = macro.commands[0]?.t || Date.now();
    for(const step of macro.commands){
      const delta = step.t - last;
      await new Promise(r => setTimeout(r, Math.max(20, delta)));
      appendLine('> ' + step.cmd, 'cmd');
      runCommand(step.cmd);
      last = step.t;
    }
    macro.lastPlayed = Date.now();
    state.macros[id] = macro;
    saveState();
    appendLine(`[MACRO] Playback finished: ${macro.name}`, 'info');
    checkChallenges();
  })();
}

/* Macro UI */
function renderMacroList(){
  macroListEl.innerHTML = '';
  for(const id in state.macros){
    const m = state.macros[id];
    const div = document.createElement('div'); div.className='macro-item';
    div.innerHTML = `<div style="font-weight:700">${m.name}</div><div class="small">${(m.commands||[]).length} cmds</div>`;
    const playBtn = document.createElement('button'); playBtn.textContent='Play';
    playBtn.addEventListener('click', ()=> playMacro(id));
    const delBtn = document.createElement('button'); delBtn.textContent='Del';
    delBtn.addEventListener('click', ()=> { delete state.macros[id]; saveState(); renderMacroList(); appendLine('[MACRO] Deleted ' + m.name, 'info'); });
    div.appendChild(playBtn); div.appendChild(delBtn);
    macroListEl.appendChild(div);
  }
}

/* Command interpreter (extended) */
const COMMANDS = ['help','list','select','status','fake-nmap','traceroute','geolocate','exfil','generate-vscode','generate-docs','generate-many','export-session','import-session','clear','history','download','info','generate-docx','generate-pdf','start-macro','stop-macro','play-macro'];

function runCommand(raw){
  if(!raw) return;
  state.cmdHistory = state.cmdHistory || [];
  state.cmdHistory.push(raw); persistState();
  recordCommandToMacro(raw);
  appendLine('> ' + raw, 'cmd');
  const parts = raw.trim().split(/\s+/);
  const cmd = parts.shift().toLowerCase();
  switch(cmd){
    case 'help':
      appendLine('Commands: ' + COMMANDS.join(', '), 'info'); break;
    case 'list':
      for(const t of targets) appendLine(`${t.id} — ${t.name} — ${t.url} — maintenance=${t.settings.maintenance}`); break;
    case 'select':
      if(parts.length===0){ appendLine('select requires id or name', 'err'); break; }
      const q = parts.join(' ');
      const found = targets.find(t => t.id===q || t.name.toLowerCase()===q.toLowerCase());
      if(found) selectTarget(found.id); else appendLine('target not found', 'err');
      break;
    case 'status':
      if(!selected) { appendLine('no target selected', 'err'); break; }
      appendLine(JSON.stringify(selected.settings, null, 2)); break;
    case 'fake-nmap':
      fakeNmap(parts[0] || selected?.url || '127.0.0.1'); break;
    case 'traceroute':
      fakeTraceroute(parts[0] || selected?.url || '127.0.0.1'); break;
    case 'geolocate':
      fakeGeolocate(parts[0] || '8.8.8.8'); break;
    case 'exfil':
      fakeExfil(); break;
    case 'generate-docx':
      generateDocx(parts.join(' ') || 'sim-doc.docx', 'Simulated docx content'); break;
    case 'generate-pdf':
      generatePdf(parts.join(' ') || 'sim-doc.pdf', 'Simulated pdf content'); break;
    case 'generate-vscode':
      generateVSCodeProject(); break;
    case 'generate-docs':
      generateDocsPack(); break;
    case 'generate-many':
      bulkGenerateFiles(); break;
    case 'export-session':
      exportSession(); break;
    case 'import-session':
      (async ()=> {
        const raw = prompt('Paste session JSON (local only):');
        if(raw){ try { const obj = JSON.parse(raw); if(obj.targets){ state.targets = obj.targets; targets = state.targets; saveState(); renderTargets(); appendLine('Session imported.', 'info'); } else appendLine('Invalid session.', 'err'); } catch(e){ appendLine('JSON parse error: '+ e.message, 'err'); } }
      })(); break;
    case 'start-macro':
      startMacroRecording(parts.join(' ') || undefined); break;
    case 'stop-macro':
      stopMacroRecording(); break;
    case 'play-macro':
      if(parts.length===0) appendLine('Usage: play-macro <macro-id-or-name>', 'err');
      else {
        const query = parts.join(' ');
        const key = Object.keys(state.macros).find(id => id===query || state.macros[id].name === query);
        if(key) playMacro(key); else appendLine('macro not found', 'err');
      }
      break;
    case 'clear':
      terminalEl.innerHTML = ''; break;
    case 'history':
      appendLine('History: ' + (state.cmdHistory||[]).slice(-30).join(' | ')); break;
    case 'download':
      generateSampleFilesAndDownload(parts[0] || 'sample-pack.zip'); break;
    case 'info':
      appendLine('Safe local simulation. No network. No real credentials.', 'info'); break;
    default:
      appendLine('Unknown command: ' + cmd, 'err');
  }
  checkChallenges();
}

/* Fake tools (kept simple) */
function fakeNmap(host){
  appendLine(`[fake-nmap] Scanning ${host} ...`, 'info');
  const ports = [22,80,443,3306,5432,8080].map(p=>({p,open:Math.random()>0.5}));
  ports.forEach((port,i)=> setTimeout(()=> appendLine(`${port.p}/tcp ${port.open ? 'open' : 'closed'} — ${port.open ? 'service' : '---'}`), i*200));
  setTimeout(()=> appendLine('[fake-nmap] Scan complete.', 'info'), ports.length*210);
}
function fakeTraceroute(host){ appendLine(`[traceroute] Tracing ${host} (simulated) ...`, 'info'); setTimeout(()=> appendLine('1\t192.0.2.1\t23 ms\n2\t198.51.100.5\t42 ms\n3\t203.0.113.7\t68 ms'), 400); }
function fakeGeolocate(ip){ appendLine(`[geolocate] ${ip} -> Simulated City, Country`, 'info'); }
function fakeExfil(){ appendLine('[exfil] Generating loot (local-only)...', 'info'); generateDocx('leaked_notes.docx', 'These are simulated leaked notes'); generatePdf('db_export.pdf', 'Simulated DB export (text wrapper)'); }

/* File generators & zip helpers */
async function generateVSCodeProject(){
  appendLine('[generate-vscode] Building sample project...', 'info');
  const files = {'README.md':'# Sample Project','src/index.js':'console.log("hello");','package.json':JSON.stringify({name:'demo'}, null, 2)};
  if(!window.JSZip) await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
  const zip = new JSZip();
  for(const k of Object.keys(files)) zip.file(k, files[k]);
  const blob = await zip.generateAsync({type:'blob'});
  triggerDownload(blob, 'vscode-sample-project.zip'); appendLine('[generate-vscode] Download started', 'info'); incrementDownloads();
}
function generateDocsPack(){ appendLine('[generate-docs] Creating docs pack...', 'info'); generateDocx('architecture.docx','Architecture notes'); generatePdf('report.pdf','Report (text)'); }
function bulkGenerateFiles(){ appendLine('[bulk] Generating many sample files...', 'info'); for(let i=1;i<=30;i++){ triggerDownload(new Blob([`Sample ${i}\n${now()}`],{type:'text/plain'}), `bulk-sample-${i}.txt`); incrementDownloads(); } }

/* Zip download helper (used by commands) */
async function generateSampleFilesAndDownload(name='sample-pack.zip'){
  if(!window.JSZip) await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
  const zip = new JSZip();
  zip.file('snippet.js','console.log("snip");'); zip.file('doc/readme.md','# Demo');
  for(let i=1;i<=8;i++) zip.file(`samples/s-${i}.txt`, `sample ${i}`);
  const blob = await zip.generateAsync({type:'blob'});
  triggerDownload(blob, name); incrementDownloads();
}

/* Session export */
function exportSession(){ const sess = { exportedAt: now(), targets: state.targets, history: state.cmdHistory, challengeProgress: state.challengeProgress }; triggerDownload(new Blob([JSON.stringify(sess, null, 2)],{type:'application/json'}), 'atlas-session.json'); appendLine('[session] Export started', 'info'); }

/* Persistence */
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function persistState(){ saveState(); }
function loadScript(url){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=url; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

/* Challenge init */
renderTargets();
renderFiles();
renderMacroList();
renderChallenges();
appendLine('ATLAS Ultimate SIM-HACK LAB (with Challenges & Macros) initialized locally. Type "help".', 'info');

/* Keyboard shortcuts + history + tab autocomplete */
cmdInput.addEventListener('keydown', (ev)=>{
  if(ev.key === 'Enter'){ ev.preventDefault(); const v = cmdInput.value.trim(); cmdInput.value=''; if(v) runCommand(v); }
  else if(ev.key === 'Tab'){ ev.preventDefault(); autocompleteCmd(); }
});
runBtn.addEventListener('click', ()=> { const v = cmdInput.value.trim(); cmdInput.value=''; if(v) runCommand(v); });
clearBtn.addEventListener('click', ()=> terminalEl.innerHTML='');
presetOps.addEventListener('change', ()=> { const v=presetOps.value; presetOps.value=''; if(v==='scan-all'){ runCommand('fake-nmap'); runCommand('traceroute'); } else if(v==='loot-export'){ runCommand('exfil'); } });

/* Autocomplete (commands & target ids) */
function autocompleteCmd(){
  const v = cmdInput.value;
  const parts = v.split(/\s+/);
  if(parts.length<=1){
    const prefix = parts[0] || '';
    const matches = COMMANDS.filter(c=>c.startsWith(prefix));
    if(matches.length) cmdInput.value = matches[0];
  } else {
    const cmd = parts[0].toLowerCase();
    if(['select','download'].includes(cmd)){
      const prefix = parts[1] || '';
      const match = targets.map(t=>t.id).find(id => id.startsWith(prefix)); if(match) cmdInput.value = cmd + ' ' + match;
    }
  }
}

/* Command history navigation */
let histIndex = (state.cmdHistory || []).length;
cmdInput.addEventListener('keydown', (ev)=>{
  const hist = state.cmdHistory || [];
  if(ev.key === 'ArrowUp'){ ev.preventDefault(); histIndex = Math.max(0, histIndex -1); cmdInput.value = hist[histIndex] || ''; }
  if(ev.key === 'ArrowDown'){ ev.preventDefault(); histIndex = Math.min(hist.length, histIndex +1); cmdInput.value = hist[histIndex] || ''; }
});

/* Macro record/play keyboard shortcuts (Ctrl+Shift+R, Ctrl+Shift+P) */
document.addEventListener('keydown', (ev)=>{
  if(ev.ctrlKey && ev.shiftKey && ev.key.toLowerCase() === 'r'){ ev.preventDefault(); if(!recording) startMacroRecording(); else appendLine('[MACRO] Already recording', 'info'); }
  if(ev.ctrlKey && ev.shiftKey && ev.key.toLowerCase() === 'p'){ ev.preventDefault(); // play last macro if any
    const keys = Object.keys(state.macros||{}); if(keys.length) playMacro(keys[keys.length-1]); else appendLine('[MACRO] No macros saved', 'err');
  }
});
btnMacroRecord.addEventListener('click', ()=> startMacroRecording());
btnMacroStop.addEventListener('click', ()=> stopMacroRecording());
btnMacroPlay.addEventListener('click', ()=> {
  const keys = Object.keys(state.macros||{}); if(keys.length) playMacro(keys[keys.length-1]); else appendLine('[MACRO] No macros saved', 'err');
});

/* Macro recording hook: record commands entered */
function recordCommandToMacro(cmd){
  if(recording && currentMacro){
    currentMacro.commands.push({ cmd, t: Date.now() });
  }
}

/* Wire up some UI buttons */
elm('btnFakeNmap').addEventListener('click', ()=> runCommand('fake-nmap'));
elm('btnTraceroute').addEventListener('click', ()=> runCommand('traceroute'));
elm('btnGeo').addEventListener('click', ()=> runCommand('geolocate 8.8.8.8'));
elm('btnExfil').addEventListener('click', ()=> runCommand('exfil'));
elm('btnGenerateVS').addEventListener('click', ()=> runCommand('generate-vscode'));
elm('btnGenerateDocs').addEventListener('click', ()=> runCommand('generate-docs'));
btnGenerateMany.addEventListener('click', ()=> runCommand('generate-many'));
btnExportSession.addEventListener('click', exportSession);

/* Matrix background (simple) */
let matrixOn = true;
const canvas = elm('matrix'); const ctx = canvas.getContext('2d');
function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; columns = Math.floor(canvas.width / 14); drops = Array(columns).fill(1); }
window.addEventListener('resize', resizeCanvas); resizeCanvas();
const letters = 'abcdefghijklmnopqrstuvwxyz0123456789@$%&*()-_=+[]{}<>/|';
let columns = Math.floor(canvas.width / 14), drops = Array(columns).fill(1);
function drawMatrix(){
  if(!matrixOn) return;
  ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#00ff99'; ctx.font = '14px monospace';
  for(let i=0;i<drops.length;i++){
    const text = letters[Math.floor(Math.random()*letters.length)];
    ctx.fillText(text, i*14, drops[i]*14);
    if(drops[i]*14 > canvas.height && Math.random() > 0.975) drops[i]=0;
    drops[i]++;
  }
  requestAnimationFrame(drawMatrix);
}
toggleMatrixBtn.addEventListener('click', ()=> { matrixOn = !matrixOn; if(matrixOn) drawMatrix(); else ctx.clearRect(0,0,canvas.width,canvas.height); });
drawMatrix();

/* Helpers: JSZip loader for zipping (on-demand) */
function loadJSZipIfNeeded(){
  if(window.JSZip) return Promise.resolve();
  return loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
}

/* Simple persistence helper */
function saveState(){ state.targets = targets; localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function persistState(){ saveState(); }

/* Initialize UI state & challenge checking */
renderTargets();
renderFiles();
renderMacroList();
renderChallenges();
checkChallenges();

/* IMPORTANT SECURITY NOTE:
   You provided an admin username/password in the chat. I will not embed or store those credentials.
   If you want a simulated account named "Eternatus" added to the local-simulation for practice, I can add it with a placeholder password, but do NOT paste real credentials into this page.
*/

/* Expose API for debugging */
window.ATLAS_SUPER = { state, runCommand, selectTarget, generateDocx, generatePdf, playMacro };

/* End of script */
</script>
</body>
</html>
