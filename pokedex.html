<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokédex - The Ultimate Version</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Existing Pokédex Styles ... */

        /* Floating Pokeball Button Styles */
        .floating-btn-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
        }
        .floating-btn-main {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 6px 18px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        .floating-btn-main img {
            width: 55px;
            height: 55px;
            pointer-events: none;
        }
        .floating-btn-options {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 180px;
            height: 180px;
            pointer-events: none;
        }
        .option-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.22);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: absolute;
            opacity: 0;
            transform: scale(0.6);
            transition: all 0.3s;
        }
        .option-btn img {
            width: 40px;
            height: 40px;
            pointer-events: none;
        }
        .option-btn.option-help { top: 30px; left: 95px; }
        .option-btn.option-catch { top: -60px; left: 55px; }
        .option-btn.option-berry { top: 60px; left: 0px; }
        .floating-btn-container.open .option-btn { opacity: 1; transform: scale(1); pointer-events: auto; }
        .option-btn:hover { background: #e4e4e4; }

        /* Pokeball shake animation for catch */
        @keyframes pokeball-shake {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-20deg); }
            40% { transform: rotate(20deg); }
            60% { transform: rotate(-15deg); }
            80% { transform: rotate(15deg); }
            100% { transform: rotate(0deg);}
        }
        .catch-animating img { animation: pokeball-shake 0.6s 3; }

        /* Modal Overlays (for help/catch) */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.47);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
        }
        .custom-modal-content {
            background: #fff;
            border-radius: 16px;
            padding: 28px 30px;
            max-width: 400px;
            width: 90vw;
            box-shadow: 0 5px 18px rgba(0,0,0,0.30);
            text-align: center;
            position: relative;
        }
        .custom-modal-close {
            position: absolute;
            right: 18px;
            top: 14px;
            font-size: 22px;
            cursor: pointer;
            color: #e4000f;
            font-weight: bold;
        }
        .catch-modal-pokemon-img { width: 120px; height: 120px; }
        .catch-modal-shake { animation: pokeball-shake 0.6s 3; }
        .catch-modal-jump { animation: jump-out 0.7s; }
        @keyframes jump-out {
            0% { transform: translateY(0);}
            30% { transform: translateY(-25px);}
            60% { transform: translateY(60px) scale(1.1);}
            100% { transform: translateY(100px) scale(0);}
        }
        .catch-info { margin-bottom: 10px;}
        .catch-count, .ball-count, .berry-count { font-size: 1rem; color: #666;}
        .paywall-message { font-size: 1.05rem; color: #c22e28; margin-top: 12px;}
        .berry-btn {
            background: #FFD700;
            color: #333;
            border: none;
            border-radius: 22px;
            padding: 7px 22px;
            font-family: 'Roboto Mono', monospace;
            cursor: pointer;
            font-size: 15px;
            margin: 8px 0 0 0;
        }
        .berry-btn:disabled {
            background: #eee;
            color: #999;
            cursor: not-allowed;
        }
        .ball-buy-btn {
            background: #e4000f;
            color: #fff;
            border: none;
            border-radius: 22px;
            padding: 7px 22px;
            font-family: 'Roboto Mono', monospace;
            cursor: pointer;
            font-size: 15px;
            margin: 8px 0 0 0;
        }
        .ball-buy-btn:disabled {
            background: #eee;
            color: #999;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Pokédex</h1>
    <div class="nav-container">
        <button class="nav-button active" data-category="all">All</button>
        <button class="nav-button" data-category="mega">Mega</button>
        <button class="nav-button" data-category="regional">Regional</button>
        <button class="nav-button" data-category="shiny">Shiny</button>
        <button class="nav-button" data-category="legendary">Legendary</button>
        <button class="nav-button" data-category="mythical">Mythical</button>
        <button class="nav-button" data-category="gmax">G-Max</button>
        <button class="nav-button" data-category="ultra-beast">Ultra Beast</button>
    </div>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search for a Pokémon...">
    </div>
    <p id="loadingMessage">Loading Pokédex...</p>
    <button id="retryButton">Retry</button>
    <div id="pokedex-container" class="pokedex-container"></div>
    <div id="pokemonModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>
    <!-- Floating Button & Options -->
    <div class="floating-btn-container" id="floatingBtnContainer">
        <div class="floating-btn-main" id="floatingBtnMain">
            <img src="ball.png" alt="Pokeball">
        </div>
        <div class="floating-btn-options">
            <div class="option-btn option-help" id="optionBtnHelp" title="Help">
                <img src="question.png" alt="Help">
            </div>
            <div class="option-btn option-catch" id="optionBtnCatch" title="Catch Pokémon">
                <img src="pokeball-outline.png" alt="Catch Pokémon">
            </div>
            <div class="option-btn option-berry" id="optionBtnBerry" title="Use Berry">
                <img src="berry.png" alt="Berry">
            </div>
        </div>
    </div>
    <!-- Help Modal -->
    <div class="custom-modal" id="helpModal">
        <div class="custom-modal-content">
            <span class="custom-modal-close" id="closeHelpModal">&times;</span>
            <h2>Pokédex Help</h2>
            <ul style="text-align:left;">
                <li>Browse, search, and explore Pokémon with all their forms and details.</li>
                <li>Use the <strong>Pokéball button</strong> at the bottom right to access extra features.</li>
                <li><strong>Catch Pokémon</strong>: Try to catch a random Pokémon! Legendary & Mythical Pokémon are harder to catch.</li>
                <li>You start with <strong>10 Pokéballs</strong> daily. You get 10 more every day.</li>
                <li>If you run out, you can buy more balls (see pay menu) or wait for your daily refill.</li>
                <li>Berries make Pokémon easier to catch. You get 3 daily, buy more if needed.</li>
                <li>For unlimited catching, pay <strong>$20/week</strong> to <a href="mailto:ethan.unlocked@gmail.com">ethan.unlocked@gmail.com</a>.</li>
            </ul>
        </div>
    </div>
    <!-- Catch Modal -->
    <div class="custom-modal" id="catchModal">
        <div class="custom-modal-content" id="catchModalContent">
            <span class="custom-modal-close" id="closeCatchModal">&times;</span>
            <!-- Content injected by JS -->
        </div>
    </div>
    <!-- Ball Shop Modal -->
    <div class="custom-modal" id="ballShopModal">
        <div class="custom-modal-content" id="ballShopModalContent">
            <span class="custom-modal-close" id="closeBallShopModal">&times;</span>
            <!-- Content injected by JS -->
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Existing Pokédex JS setup ---
        // ... [Your Pokédex JS code for loading/displaying Pokémon] ...
        const pokedexContainer = document.getElementById('pokedex-container');
        const searchInput = document.getElementById('searchInput');
        const loadingMessage = document.getElementById('loadingMessage');
        const retryButton = document.getElementById('retryButton');
        const pokemonModal = document.getElementById('pokemonModal');
        const modalBody = document.getElementById('modal-body');
        const closeModal = document.querySelector('.close-button');
        const navButtons = document.querySelectorAll('.nav-button');
        let allPokemon = [];
        const cachedSpeciesData = {};
        const cachedVarietyData = {};
        const ULTRA_BEASTS = ['nihilego', 'buzzwole', 'pheromosa', 'xurkitree', 'celesteela', 'kartana', 'guzzlord', 'poipole', 'naganadel', 'stakataka', 'blacephalon'];
        // ... [rest of Pokédex code] ...

        // --- Floating Button Logic ---
        const floatingBtnContainer = document.getElementById('floatingBtnContainer');
        const floatingBtnMain = document.getElementById('floatingBtnMain');
        const optionBtnHelp = document.getElementById('optionBtnHelp');
        const optionBtnCatch = document.getElementById('optionBtnCatch');
        const optionBtnBerry = document.getElementById('optionBtnBerry');
        const helpModal = document.getElementById('helpModal');
        const closeHelpModal = document.getElementById('closeHelpModal');
        const catchModal = document.getElementById('catchModal');
        const closeCatchModal = document.getElementById('closeCatchModal');
        const catchModalContent = document.getElementById('catchModalContent');
        const ballShopModal = document.getElementById('ballShopModal');
        const ballShopModalContent = document.getElementById('ballShopModalContent');
        const closeBallShopModal = document.getElementById('closeBallShopModal');

        // Ball and Berry logic
        const BALL_KEY = 'pokeBalls';
        const BERRY_KEY = 'pokeBerries';
        const REFILL_DATE_KEY = 'pokeRefillDate';
        const DAILY_BALLS = 10;
        const DAILY_BERRIES = 3;
        let pokeBalls = 0;
        let pokeBerries = 0;
        function resetDailyItemsIfNeeded() {
            const todayStr = new Date().toISOString().substr(0,10);
            const lastDate = localStorage.getItem(REFILL_DATE_KEY);
            if (!lastDate || lastDate !== todayStr) {
                localStorage.setItem(REFILL_DATE_KEY, todayStr);
                localStorage.setItem(BALL_KEY, DAILY_BALLS);
                localStorage.setItem(BERRY_KEY, DAILY_BERRIES);
            }
            pokeBalls = parseInt(localStorage.getItem(BALL_KEY) || DAILY_BALLS);
            pokeBerries = parseInt(localStorage.getItem(BERRY_KEY) || DAILY_BERRIES);
        }
        resetDailyItemsIfNeeded();
        function updateBalls(n) {
            pokeBalls = Math.max(0, n);
            localStorage.setItem(BALL_KEY, pokeBalls);
        }
        function updateBerries(n) {
            pokeBerries = Math.max(0, n);
            localStorage.setItem(BERRY_KEY, pokeBerries);
        }

        // --- Actual attack sound logic ---
        async function playAttackSound(pokemon) {
            // Use the actual main move (not random)
            const move = pokemon.moves && pokemon.moves.length ? pokemon.moves[0].move.name : null;
            if (!move) return;
            const attackAudio = new Audio(`https://play.pokemonshowdown.com/audio/moves/${move}.mp3`);
            attackAudio.volume = 0.7;
            attackAudio.play();
        }

        // --- Floating button events ---
        floatingBtnMain.addEventListener('click', () => {
            floatingBtnContainer.classList.toggle('open');
        });

        optionBtnHelp.addEventListener('click', () => {
            helpModal.style.display = 'flex';
            floatingBtnContainer.classList.remove('open');
        });
        closeHelpModal.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });

        // Berry option opens ball shop
        optionBtnBerry.addEventListener('click', () => {
            showBallShop();
            floatingBtnContainer.classList.remove('open');
        });

        function showBallShop() {
            ballShopModalContent.innerHTML = `
                <span class="custom-modal-close" id="closeBallShopModal">&times;</span>
                <h2>Poké Ball & Berry Shop</h2>
                <div class="ball-count">Balls: <strong>${pokeBalls}</strong></div>
                <div class="berry-count">Berries: <strong>${pokeBerries}</strong></div>
                <h3>Buy Balls</h3>
                <button class="ball-buy-btn" data-balls="10" data-price="2">$2 for 10 Balls</button>
                <button class="ball-buy-btn" data-balls="30" data-price="4">$4 for 30 Balls</button>
                <button class="ball-buy-btn" data-balls="100" data-price="10">$10 for 100 Balls</button>
                <h3>Buy Berries</h3>
                <button class="ball-buy-btn" data-berries="3" data-price="1">$1 for 3 Berries</button>
                <button class="ball-buy-btn" data-berries="10" data-price="3">$3 for 10 Berries</button>
                <div class="paywall-message" style="margin-top:18px;">Pay via PayPal (<a href="mailto:ethan.unlocked@gmail.com">ethan.unlocked@gmail.com</a>) after contacting site owner.</div>
            `;
            ballShopModal.style.display = 'flex';
            document.getElementById('closeBallShopModal').onclick = () => { ballShopModal.style.display = 'none'; };
            ballShopModalContent.querySelectorAll('.ball-buy-btn').forEach(btn => {
                btn.onclick = () => {
                    let balls = btn.getAttribute('data-balls');
                    let berries = btn.getAttribute('data-berries');
                    let price = btn.getAttribute('data-price');
                    let msg = '';
                    if (balls) {
                        msg = `To buy ${balls} Pokéballs for $${price}, email <a href="mailto:ethan.unlocked@gmail.com">ethan.unlocked@gmail.com</a> with your username and payment method.`;
                    } else if (berries) {
                        msg = `To buy ${berries} berries for $${price}, email <a href="mailto:ethan.unlocked@gmail.com">ethan.unlocked@gmail.com</a> with your username and payment method.`;
                    }
                    ballShopModalContent.innerHTML = `
                        <span class="custom-modal-close" id="closeBallShopModal">&times;</span>
                        <h2>How to Buy</h2>
                        <div class="paywall-message" style="margin-bottom:10px;">${msg}</div>
                        <button class="ball-buy-btn" id="backToShop">Back</button>
                    `;
                    document.getElementById('closeBallShopModal').onclick = () => { ballShopModal.style.display = 'none'; };
                    document.getElementById('backToShop').onclick = showBallShop;
                };
            });
        }
        closeBallShopModal.addEventListener('click', () => {
            ballShopModal.style.display = 'none';
        });

        // --- Catch Pokémon Logic (with balls/berries) ---
        optionBtnCatch.addEventListener('click', async () => {
            resetDailyItemsIfNeeded();
            floatingBtnContainer.classList.remove('open');
            if (pokeBalls <= 0) {
                catchModalContent.innerHTML = `
                    <span class="custom-modal-close" id="closeCatchModal">&times;</span>
                    <h2>No Pokéballs</h2>
                    <div class="catch-info">You have 0 Pokéballs. Visit the shop to buy more or wait for daily refill.</div>
                    <button class="ball-buy-btn" id="openBallShopBtn">Open Shop</button>
                    <div class="catch-count">Balls: ${pokeBalls}</div>
                `;
                catchModal.style.display = 'flex';
                document.getElementById('closeCatchModal').onclick = () => { catchModal.style.display = 'none'; };
                document.getElementById('openBallShopBtn').onclick = () => {
                    catchModal.style.display = 'none';
                    showBallShop();
                };
                return;
            }
            // Pick random Pokémon (prefer non-empty artwork)
            const candidates = allPokemon.filter(p => p.sprites.front_default || p.sprites.other['official-artwork'].front_default);
            const randomIdx = Math.floor(Math.random() * candidates.length);
            const randomPokemon = candidates[randomIdx];
            const species = cachedSpeciesData[getSpeciesNameFromVarietyName(randomPokemon.name)];
            // Rarity
            let rarity = 1;
            if (species && species.is_mythical) rarity = 3;
            else if (species && species.is_legendary) rarity = 2;
            else if (ULTRA_BEASTS.includes(randomPokemon.name)) rarity = 2.5;
            else if (randomPokemon.name.includes('-gmax') || randomPokemon.name.includes('-mega') || randomPokemon.name.includes('-primal') ||
                    randomPokemon.name.includes('-alola') || randomPokemon.name.includes('-galar') || randomPokemon.name.includes('-hisui')) rarity = 2.2;
            // Base catch rate
            let catchChance = 0.8;
            if (rarity === 2) catchChance = 0.45;
            if (rarity === 2.2) catchChance = 0.35;
            if (rarity === 2.5) catchChance = 0.3;
            if (rarity === 3) catchChance = 0.15;
            // Berry bonus
            let berryUsed = false;
            let berryBonus = 0;
            function renderCatchModal() {
                catchModalContent.innerHTML = `
                    <span class="custom-modal-close" id="closeCatchModal">&times;</span>
                    <h2>Catch Pokémon</h2>
                    <div class="catch-info">A wild <strong>${randomPokemon.name.replace(/-/g, ' ')}</strong> appeared!</div>
                    <img src="${getPokemonImageUrl(randomPokemon)}" class="catch-modal-pokemon-img" alt="${randomPokemon.name}">
                    <div id="catchShakeAnim">
                        <img src="pokeball-outline.png" alt="Pokeball" style="width:60px; height:60px;">
                    </div>
                    <button id="throwBallBtn" style="margin-top:14px; background:#e4000f;color:#fff;border-radius:22px;padding:7px 24px;border:none;font-family:'Roboto Mono',monospace;font-size:16px;cursor:pointer;">Throw Pokéball</button>
                    <div class="ball-count">Balls: ${pokeBalls}</div>
                    <div class="berry-count">Berries: ${pokeBerries}</div>
                    <button class="berry-btn" id="useBerryBtn" ${pokeBerries<=0||berryUsed?'disabled':''}>${berryUsed?'Berry Used!':'Use Berry'}</button>
                `;
                document.getElementById('useBerryBtn').onclick = () => {
                    if (pokeBerries > 0 && !berryUsed) {
                        berryUsed = true;
                        berryBonus = 0.25;
                        updateBerries(pokeBerries-1);
                        renderCatchModal();
                    }
                };
                document.getElementById('throwBallBtn').onclick = async () => {
                    if (pokeBalls <= 0) return;
                    updateBalls(pokeBalls-1);
                    let shakes = 0;
                    let result = false;
                    for(let i=1;i<=3;i++) {
                        shakes++;
                        document.getElementById('catchShakeAnim').classList.add('catch-animating');
                        await new Promise(res=>setTimeout(res,600));
                        document.getElementById('catchShakeAnim').classList.remove('catch-animating');
                        if (Math.random() < catchChance + berryBonus) {
                            result = true;
                            break;
                        }
                    }
                    if (result) {
                        catchModalContent.innerHTML = `
                            <span class="custom-modal-close" id="closeCatchModal">&times;</span>
                            <h2>Success!</h2>
                            <div class="catch-info">You caught <strong>${randomPokemon.name.replace(/-/g, ' ')}</strong>!</div>
                            <img src="${getPokemonImageUrl(randomPokemon)}" class="catch-modal-pokemon-img" alt="${randomPokemon.name}">
                            <div class="ball-count">Balls: ${pokeBalls}</div>
                            <div class="berry-count">Berries: ${pokeBerries}</div>
                            <button id="catchAnotherBtn" style="margin-top:14px; background:#6390F0;color:#fff;border-radius:22px;padding:7px 22px;border:none;font-family:'Roboto Mono',monospace;font-size:15px;cursor:pointer;">Catch Another</button>
                        `;
                        document.getElementById('catchAnotherBtn').onclick = () => {
                            catchModal.style.display = 'none';
                            optionBtnCatch.click();
                        };
                        document.getElementById('closeCatchModal').onclick = () => { catchModal.style.display = 'none'; };
                    } else {
                        catchModalContent.innerHTML = `
                            <span class="custom-modal-close" id="closeCatchModal">&times;</span>
                            <h2>Oh no!</h2>
                            <div class="catch-info">The <strong>${randomPokemon.name.replace(/-/g, ' ')}</strong> jumped out! Try again.</div>
                            <img src="${getPokemonImageUrl(randomPokemon)}" class="catch-modal-pokemon-img catch-modal-jump" alt="${randomPokemon.name}">
                            <div class="ball-count">Balls: ${pokeBalls}</div>
                            <div class="berry-count">Berries: ${pokeBerries}</div>
                            <button id="tryAgainBtn" style="margin-top:14px; background:#e4000f;color:#fff;border-radius:22px;padding:7px 22px;border:none;font-family:'Roboto Mono',monospace;font-size:15px;cursor:pointer;">Try Again</button>
                        `;
                        document.getElementById('tryAgainBtn').onclick = () => {
                            catchModal.style.display = 'none';
                            optionBtnCatch.click();
                        };
                        document.getElementById('closeCatchModal').onclick = () => { catchModal.style.display = 'none'; };
                    }
                };
                document.getElementById('closeCatchModal').onclick = () => { catchModal.style.display = 'none'; };
            }
            renderCatchModal();
            catchModal.style.display = 'flex';
        });
        closeCatchModal.addEventListener('click', () => {
            catchModal.style.display = 'none';
        });

        // --- Fix Attack Sound in Modal ---
        const showPokemonDetails = async (pokemon, isShiny = false) => {
            // ...existing modal logic...
            const speciesName = getSpeciesNameFromVarietyName(pokemon.name);
            const speciesData = await getSpeciesData(speciesName);
            const varieties = await Promise.all(speciesData.varieties.map(v => getPokemonData(v.pokemon.name)));
            renderModalContent(pokemon, speciesData, varieties, isShiny);
            pokemonModal.style.display = 'block';
            const modalImage = document.querySelector('#modal-body .modal-image');
            modalImage.onclick = async () => {
                modalImage.classList.remove('attack');
                void modalImage.offsetWidth;
                modalImage.classList.add('attack');
                await playAttackSound(pokemon);
            };
        };

        // ...rest of Pokédex code unchanged...
    });
    </script>
</body>
</html>
