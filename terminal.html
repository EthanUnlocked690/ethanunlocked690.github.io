<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS: DATA FLOW CONSOLE v5.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* General Console Theme */
        body {
            background-color: #000;
            font-family: 'VT323', monospace;
            color: #00ff41; /* Console Green (Default) */
            font-size: 1.1rem;
            line-height: 1.4;
            height: 100vh;
            margin: 0;
            overflow: hidden; 
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; 
            transition: color 0.5s, border-color 0.5s, background-color 0.1s; 
        }

        /* --- Animated Background Layer --- */
        #terminal-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; 
            background-size: cover;
            background-position: center;
            opacity: 0.3; 
            filter: grayscale(100%) brightness(50%); 
            transition: background-image 0.5s ease, filter 0.5s, opacity 0.5s;
            /* Placeholder background image, replace with a real one if needed */
            background-image: url('https://placehold.co/1920x1080/000/00ff41?text=ATLAS+GRID');
        }

        /* Simulated CRT/Scanline Effect */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                #000, 
                #000 1px, 
                rgba(0, 255, 65, 0.08) 2px, 
                #000 3px
            );
            opacity: 0.8;
            z-index: -1;
            transition: background 0.5s;
        }

        /* --- LOCKDOWN EFFECT CSS --- */
        .lockdown-active {
            background-color: #500000 !important; 
            color: #ff0000 !important; 
        }
        .lockdown-active .console-container {
            border-color: #ff0000 !important;
            box-shadow: 0 0 15px #ff0000 !important;
            animation: lockdown-flash 0.1s infinite alternate; 
        }
        .lockdown-active body::before {
            background: repeating-linear-gradient(#500000, #500000 1px, rgba(255, 0, 0, 0.15) 2px, #500000 3px);
            opacity: 1;
        }
        @keyframes lockdown-flash {
            from { opacity: 1; }
            to { opacity: 0.8; }
        }
        /* --- End LOCKDOWN EFFECT CSS --- */


        .console-container {
            border: 3px solid #00ff41; 
            box-shadow: 0 0 10px #00ff41; 
            height: 95vh;
            display: flex;
            flex-direction: column;
            margin: 10px auto;
            max-width: 1000px;
            width: 95%; 
            position: relative; 
            transition: transform 0.1s ease-in-out, border-color 0.5s, box-shadow 0.5s; 
        }

        /* Output Area */
        #output-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.9);
            white-space: pre-wrap;
        }

        /* Input Area */
        #input-line {
            padding: 1rem;
            border-top: 1px solid; /* Handled by theme color */
            display: flex;
            transition: border-top 0.5s;
        }

        #input-prefix {
            color: #ff00ff; 
        }

        #command-input {
            background: transparent;
            border: none;
            color: inherit; 
            flex-grow: 1;
            outline: none;
            margin-left: 5px;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
        }
        
        /* Status Bar */
        #status-bar {
            background: #004d1a;
            color: #fff;
            padding: 0.5rem 1rem;
            text-align: right;
            font-size: 0.9rem;
            transition: background 0.5s;
        }
        
        /* THEME & Game Styles */
        .blue-theme { color: #00d0ff; }
        .red-theme { color: #ff3030; }
        .blue-theme .console-container { border-color: #00d0ff; box-shadow: 0 0 10px #00d0ff; }
        .red-theme .console-container { border-color: #ff3030; box-shadow: 0 0 10px #ff3030; }

        /* Game Container Styles */
        #game-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.95);
        }

        #t-rex-canvas, #pong-canvas {
            border: 2px solid #00ff41;
            box-shadow: 0 0 10px #00ff41;
            max-width: 100%;
            height: auto;
            background: #000; /* Default background for games */
        }

        #t-rex-canvas.classic-theme {
            background: #f7f7f7; /* Light background for Chrome T-Rex look */
            border-color: #ccc;
            box-shadow: none;
        }
        
        #game-status-box {
            color: #ffff00;
            background: #004d1a;
            padding: 0.5rem 1rem;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #00ff41;
            max-width: 800px;
            width: 95%;
            font-size: 1.2rem;
        }
        
    </style>
</head>
<body>
    
    <!-- Audio Placeholder (You need to provide hack.mp3, siren.mp3, and SFX files) -->
    <audio id="siren-audio" preload="auto">
        <!-- Using a generic placeholder URL for siren audio -->
        <source src="https://tonejs.github.io/examples/audio/siren.mp3" type="audio/mp3"> 
    </audio>
    <audio id="sfx-audio" preload="auto"></audio>
    <audio id="game-sfx" preload="auto"></audio>
    
    <div id="terminal-background"></div>

    <div class="console-container">
        
        <div id="status-bar">
            <span id="sound-status" style="color: #00ff41; float: left; margin-right: 20px;">[SFX DATABASE ONLINE]</span>
            
            <span id="lockdown-indicator" style="color: #ff0000; float: left; display: none;">[LOCKDOWN ACTIVE]</span>
            <span id="override-indicator" style="color: #ffff00; float: left; display: none; margin-right: 20px;">[ALPHA OVERRIDE]</span>
            ATLAS CONSOLE v5.5 | OPERATOR: E.I. | <span id="auth-status">STATUS: LOCAL</span> | SYSTEM: STANDALONE
        </div>

        <!-- CONSOLE OUTPUT AREA (Active when game is NOT running) -->
        <div id="output-area">
            [[INITIATING ACCESS. . .]]<br>
            [[WELCOME, OPERATOR. LEVEL EXTREME CLEARANCE CONFIRMED.]]<br>
            <br>
            Type **HELP** for available commands.
            <br>
        </div>

        <!-- GAME CONTAINER (Active when game IS running) -->
        <div id="game-container" style="display:none;">
            <!-- Only one canvas is shown at a time -->
            <canvas id="t-rex-canvas" style="display:none;"></canvas>
            <canvas id="pong-canvas" style="display:none;"></canvas>

            <div id="game-status-box" class="flex justify-between">
                 <span>Game: <span id="game-name"></span></span>
                 <span>Score: <span id="game-score">0</span></span>
                 <span id="game-message">Press SPACE to Start</span>
            </div>
        </div>

        <div id="input-line">
            <span id="input-prefix">ATLAS ></span>
            <input type="text" id="command-input" autofocus>
        </div>
        
    </div>

    <script>
        // --- GLOBAL ELEMENTS & STATE ---
        const outputArea = document.getElementById('output-area');
        const gameContainer = document.getElementById('game-container');
        const commandInput = document.getElementById('command-input');
        const consoleContainer = document.querySelector('.console-container');
        const bodyElement = document.body; 
        const lockdownIndicator = document.getElementById('lockdown-indicator');
        const overrideIndicator = document.getElementById('override-indicator');
        const sirenAudio = document.getElementById('siren-audio'); 
        const inputPrefix = document.getElementById('input-prefix');
        const sfxAudio = document.getElementById('sfx-audio'); 
        const authStatus = document.getElementById('auth-status'); 
        const gameSfxAudio = document.getElementById('game-sfx');

        let isBusy = false; 
        let isLockedDown = false; 
        let overrideActive = false; 
        let isGameActive = false; 
        let currentGameEngine = null; // Holds the active game's control object

        // Hardcoded admin credential for local lockdown bypass
        const ADMIN_USERNAME = "EthanUnlocked"; 
        const SFX_SEARCH_TIME_MS = 3000; 
        
        // --- GAME DEFINITIONS ---
        const GAMES = {
            'T-REX': { name: 'T-REX RUNNER', engine: initializeTRexGame, aliases: ['DINOSAUR', 'DINO'], canvasId: 't-rex-canvas', controls: 'JUMP: SPACE or UP Arrow' },
            'PONG': { name: 'PONG CLASSIC', engine: initializePongGame, aliases: ['TABLETENNIS'], canvasId: 'pong-canvas', controls: 'PADDLE: UP and DOWN Arrows' },
        };
        
        // --- THEME DATA ---
        const THEMES = {
            'DEFAULT': { className: '', mainColor: '#00ff41' },
            'BLUE': { className: 'blue-theme', mainColor: '#00d0ff' },
            'RED': { className: 'red-theme', mainColor: '#ff3030' },
            'OVERRIDE': { className: 'override-theme', mainColor: '#ffff00' }
        };
        let currentTheme = 'DEFAULT';

        // --- SOUND EFFECT LIBRARY ---
        const SOUND_EFFECTS = {
            // Using generic placeholders since no external files can be guaranteed
            'GET OUT': 'https://tonejs.github.io/examples/audio/bloop.mp3', 
            'VINE-BOOM': 'https://tonejs.github.io/examples/audio/ping.mp3', 
            'ALERT': 'https://tonejs.github.io/examples/audio/error.mp3', 
            'CONFIRM': 'https://tonejs.github.io/examples/audio/click.mp3', 
        };

        // =========================================================================
        // --- Utility Functions ---
        // =========================================================================

        function writeOutput(text, color = THEMES[currentTheme].mainColor) {
            const line = document.createElement('span');
            line.style.color = color;
            line.innerHTML = text; 
            outputArea.appendChild(line);
            outputArea.appendChild(document.createElement('br'));
            outputArea.scrollTop = outputArea.scrollHeight;
        }

        function showPrompt() {
            if (isLockedDown && !isAdmin() || isGameActive) return; 
            if (!isBusy) {
                writeOutput("", THEMES[currentTheme].mainColor);
            }
            commandInput.focus();
            commandInput.value = '';
        }

        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i <ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) === 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
        
        function getUsername() {
            // Using a simple check to see if the username cookie is set
            return getCookie('username').trim();
        }
        
        function isAdmin() {
            return getUsername().toLowerCase() === ADMIN_USERNAME.toLowerCase();
        }
        
        function applyOverrideTheme() {
            bodyElement.style.color = '#ffff00'; 
            consoleContainer.style.borderColor = '#ffff00';
            consoleContainer.style.boxShadow = '0 0 15px #ffff00, 0 0 30px rgba(255, 255, 0, 0.5)';
            inputPrefix.style.color = '#ff00ff'; 
            
            document.getElementById('status-bar').style.backgroundColor = '#4d4d00'; 
            overrideIndicator.style.display = 'inline'; 
            
            overrideActive = true;
            currentTheme = 'OVERRIDE';
            isBusy = false; 
        }
        
        // --- AUDIO UNLOCK FUNCTION (for Autoplay Policy) ---
        let audioContextUnlocked = false;
        function unlockAudioContext() {
            if (audioContextUnlocked) return;
            sfxAudio.muted = true;
            sfxAudio.play().catch(e => {
                // Ignore expected initial failure
            }).finally(() => {
                sfxAudio.pause();
                sfxAudio.muted = false;
            });
            audioContextUnlocked = true;
            document.body.removeEventListener('click', unlockAudioContext);
            document.body.removeEventListener('keydown', unlockAudioContext);
        }

        // =========================================================================
        // --- GAME ENGINE LOGIC ---
        // =========================================================================

        function startGame(gameKey) {
            const gameDef = GAMES[gameKey];
            if (!gameDef) {
                writeOutput(`ERROR: Game '${gameKey}' not found.`, '#ff0000');
                return;
            }

            // Hide all canvases, then show the current one
            document.getElementById('t-rex-canvas').style.display = 'none';
            document.getElementById('pong-canvas').style.display = 'none';
            const canvas = document.getElementById(gameDef.canvasId);
            canvas.style.display = 'block';

            // 1. Switch View
            isGameActive = true;
            outputArea.style.display = 'none';
            gameContainer.style.display = 'flex';
            document.getElementById('game-name').textContent = gameDef.name;
            document.getElementById('game-score').textContent = '0';
            document.getElementById('game-message').textContent = 'Loading...';
            
            // Keep input enabled so the user can type 'EXIT'. 
            commandInput.disabled = false; 

            // 2. Write console message
            writeOutput(`\n>>> INITIATING GAME: **${gameDef.name.toUpperCase()}**. Controls: ${gameDef.controls}. Type **EXIT** to return. <<<`, '#00ffff');
            
            // 3. Start Game Engine and save the control object
            currentGameEngine = gameDef.engine(canvas);

            // 4. Capture keyboard events for game only
            document.addEventListener('keydown', handleGameInput);
            document.addEventListener('keyup', handleGameInput);
        }

        function endGame() {
            if (!isGameActive) return;

            // 1. Stop Game Engine
            if (currentGameEngine && currentGameEngine.stop) currentGameEngine.stop();
            currentGameEngine = null;

            // 2. Switch View
            isGameActive = false;
            gameContainer.style.display = 'none';
            outputArea.style.display = 'block';
            document.getElementById('t-rex-canvas').style.display = 'none';
            document.getElementById('pong-canvas').style.display = 'none';
            commandInput.disabled = isLockedDown && !isAdmin();
            
            // 3. Clean up events
            document.removeEventListener('keydown', handleGameInput);
            document.removeEventListener('keyup', handleGameInput);

            writeOutput("\n>>> GAME SESSION TERMINATED. Console restored. <<<", '#00ff41');
            showPrompt();
        }

        function handleGameInput(e) {
            if (currentGameEngine && currentGameEngine.handleInput) {
                currentGameEngine.handleInput(e);
            }
        }
        
        // --- PONG Game Implementation ---
        function initializePongGame(canvas) {
            const ctx = canvas.getContext('2d');
            const scoreElement = document.getElementById('game-score');
            const messageElement = document.getElementById('game-message');
            
            const CANVAS_W = 700;
            const CANVAS_H = 350;
            canvas.width = CANVAS_W;
            canvas.height = CANVAS_H;
            canvas.classList.remove('classic-theme');
            canvas.style.backgroundColor = 'black';
            
            // Game Constants
            const PADDLE_W = 10;
            const PADDLE_H = 60;
            const BALL_SIZE = 10;
            let PADDLE_SPEED = 6;

            // Game State
            let p1 = { x: 20, y: CANVAS_H / 2 - PADDLE_H / 2, dy: 0, score: 0 };
            let p2 = { x: CANVAS_W - 20 - PADDLE_W, y: CANVAS_H / 2 - PADDLE_H / 2, dy: 0, score: 0 };
            let ball = { x: CANVAS_W / 2, y: CANVAS_H / 2, dx: 4, dy: 4 };

            let isRunning = false;
            let gameLoop = null;

            const drawRect = (x, y, w, h, color) => {
                ctx.fillStyle = color;
                ctx.fillRect(x, y, w, h);
            };

            const drawNet = () => {
                ctx.strokeStyle = '#00ff4180';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.moveTo(CANVAS_W / 2, 0);
                ctx.lineTo(CANVAS_W / 2, CANVAS_H);
                ctx.stroke();
                ctx.setLineDash([]);
            };

            const updatePaddle = (p) => {
                p.y += p.dy;
                if (p.y < 0) p.y = 0;
                if (p.y > CANVAS_H - PADDLE_H) p.y = CANVAS_H - PADDLE_H;
            };

            const resetBall = () => {
                ball.x = CANVAS_W / 2;
                ball.y = CANVAS_H / 2;
                
                // Randomize direction
                ball.dx = (Math.random() > 0.5 ? 1 : -1) * 4;
                ball.dy = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * 4 + 2);
            };

            const updateBall = () => {
                ball.x += ball.dx;
                ball.y += ball.dy;

                // Wall collision (top/bottom)
                if (ball.y < 0 || ball.y > CANVAS_H - BALL_SIZE) {
                    ball.dy *= -1;
                    gameSfxAudio.src = SOUND_EFFECTS.CONFIRM; 
                    gameSfxAudio.play().catch(e => {});
                }

                // Paddle collision (P1)
                if (ball.x < p1.x + PADDLE_W && ball.x > p1.x &&
                    ball.y + BALL_SIZE > p1.y && ball.y < p1.y + PADDLE_H) {
                    ball.dx *= -1;
                    // Adjust speed slightly
                    ball.dx *= 1.05;
                    ball.dy += p1.dy * 0.5; // Transfer paddle momentum
                    gameSfxAudio.src = SOUND_EFFECTS['VINE-BOOM']; 
                    gameSfxAudio.play().catch(e => {});
                }

                // Paddle collision (P2)
                if (ball.x + BALL_SIZE > p2.x && ball.x < p2.x + PADDLE_W &&
                    ball.y + BALL_SIZE > p2.y && ball.y < p2.y + PADDLE_H) {
                    ball.dx *= -1;
                    // Adjust speed slightly
                    ball.dx *= 1.05;
                    ball.dy += p2.dy * 0.5; 
                    gameSfxAudio.src = SOUND_EFFECTS['VINE-BOOM']; 
                    gameSfxAudio.play().catch(e => {});
                }

                // Score check (right wall)
                if (ball.x > CANVAS_W) {
                    p1.score++;
                    resetBall();
                    updateScore();
                }

                // Score check (left wall)
                if (ball.x < 0 - BALL_SIZE) {
                    p2.score++;
                    resetBall();
                    updateScore();
                }
            };
            
            const updateScore = () => {
                scoreElement.textContent = `${p1.score} : ${p2.score}`;
                if (p1.score >= 5 || p2.score >= 5) {
                    gameOver();
                }
            };

            const loop = () => {
                ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);

                if (isRunning) {
                    updatePaddle(p1);
                    updatePaddle(p2);
                    updateBall();
                }
                
                // Draw everything
                drawNet();
                drawRect(p1.x, p1.y, PADDLE_W, PADDLE_H, '#00ffff');
                drawRect(p2.x, p2.y, PADDLE_W, PADDLE_H, '#ff00ff');
                drawRect(ball.x, ball.y, BALL_SIZE, BALL_SIZE, '#ffff00');

                if (isRunning) {
                    gameLoop = requestAnimationFrame(loop);
                }
            };
            
            const resetGame = () => {
                p1.score = 0; p2.score = 0;
                p1.y = CANVAS_H / 2 - PADDLE_H / 2; p2.y = CANVAS_H / 2 - PADDLE_H / 2;
                p1.dy = 0; p2.dy = 0;
                resetBall();
                updateScore();
                isRunning = false;
                messageElement.textContent = 'PONG: Press SPACE to Start';
                cancelAnimationFrame(gameLoop);
                gameLoop = requestAnimationFrame(loop);
            };

            const startRunning = () => {
                if (!isRunning) {
                    isRunning = true;
                    messageElement.textContent = 'Type EXIT to stop';
                    gameLoop = requestAnimationFrame(loop);
                }
            };

            const gameOver = () => {
                isRunning = false;
                const winner = p1.score > p2.score ? 'PLAYER 1' : 'PLAYER 2';
                messageElement.textContent = `GAME OVER! ${winner} WINS! Press SPACE to Restart.`;
                gameSfxAudio.src = SOUND_EFFECTS.ALERT; 
                gameSfxAudio.play().catch(e => {});
                cancelAnimationFrame(gameLoop);
            };

            const handleInput = (e) => {
                if (e.type === 'keydown') {
                    if (e.key === ' ' && !isRunning) {
                        e.preventDefault();
                        if (p1.score >= 5 || p2.score >= 5) {
                            resetGame();
                        }
                        startRunning();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        p2.dy = -PADDLE_SPEED;
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        p2.dy = PADDLE_SPEED;
                    }
                    // Player 1 controls (W/S) - Simple single player vs wall/CPU for now
                    if (e.key.toLowerCase() === 'w') {
                        e.preventDefault();
                        p1.dy = -PADDLE_SPEED;
                    } else if (e.key.toLowerCase() === 's') {
                        e.preventDefault();
                        p1.dy = PADDLE_SPEED;
                    }

                } else if (e.type === 'keyup') {
                    if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                        p2.dy = 0;
                    }
                    if (e.key.toLowerCase() === 'w' || e.key.toLowerCase() === 's') {
                        p1.dy = 0;
                    }
                }
            };
            
            resetGame();

            return { stop: () => { isRunning = false; cancelAnimationFrame(gameLoop); }, handleInput };
        }
        
        // --- T-Rex Runner Game Implementation ---
        function initializeTRexGame(canvas) {
            const ctx = canvas.getContext('2d');
            const scoreElement = document.getElementById('game-score');
            const messageElement = document.getElementById('game-message');

            // Set Chrome Classic Theme
            canvas.classList.add('classic-theme');
            
            // Responsive Canvas Sizing
            const parentWidth = gameContainer.clientWidth - 40; 
            const CANVAS_W = Math.min(800, parentWidth);
            const CANVAS_H = 150; 

            canvas.width = CANVAS_W;
            canvas.height = CANVAS_H;

            // Game Constants
            const GROUND_Y = CANVAS_H - 10;
            const JUMP_VELOCITY = -10;
            const GRAVITY = 0.6; 
            let GAME_SPEED = 4;
            const DINO_SIZE = 20;
            const CACTUS_WIDTH = 10;
            const CACTUS_HEIGHT = 20;

            // Game State
            let dino = { x: 20, y: GROUND_Y - DINO_SIZE, dy: 0, isJumping: false };
            let obstacles = [];
            let score = 0;
            let frameCount = 0;
            let nextCactusFrame = 100; 
            let isRunning = false;
            let isGameOver = false;
            let gameLoop = null;

            // --- Drawing Functions ---
            const drawGround = () => {
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, GROUND_Y);
                ctx.lineTo(canvas.width, GROUND_Y);
                ctx.stroke();
            };
            
            // Simple Pixelated Dino (Triangle/Box approximation)
            const drawDino = () => {
                ctx.fillStyle = '#555';
                
                // Body (simple block)
                ctx.fillRect(dino.x, dino.y, DINO_SIZE, DINO_SIZE);
                // Head (simple block extension)
                ctx.fillRect(dino.x + DINO_SIZE, dino.y + DINO_SIZE / 2, 5, 5);
                // Legs (just for appearance)
                ctx.fillRect(dino.x + 2, dino.y + DINO_SIZE, 5, 2);
                ctx.fillRect(dino.x + DINO_SIZE - 7, dino.y + DINO_SIZE, 5, 2);
            };

            // Simple Pixelated Cactus
            const drawCactus = (obs) => {
                ctx.fillStyle = '#555';
                ctx.fillRect(obs.x, GROUND_Y - obs.height, obs.width, obs.height);
                // Simple arm
                if (obs.height > 20) {
                    ctx.fillRect(obs.x + obs.width, GROUND_Y - obs.height + 5, 5, 3);
                }
            };

            const drawScore = () => {
                scoreElement.textContent = Math.floor(score).toString().padStart(5, '0');
            };

            // --- Game Logic ---
            const updateDino = () => {
                if (dino.isJumping) {
                    dino.y += dino.dy;
                    dino.dy += GRAVITY;

                    if (dino.y >= GROUND_Y - DINO_SIZE) {
                        dino.y = GROUND_Y - DINO_SIZE;
                        dino.isJumping = false;
                        dino.dy = 0;
                    }
                }
            };

            const updateObstacles = () => {
                for (let i = obstacles.length - 1; i >= 0; i--) {
                    obstacles[i].x -= GAME_SPEED;
                    if (obstacles[i].x + obstacles[i].width < 0) {
                        obstacles.splice(i, 1);
                    }
                }

                if (frameCount > nextCactusFrame) {
                    const cactusHeight = Math.random() > 0.6 ? 30 : 20; // Two sizes
                    obstacles.push({ x: canvas.width, width: CACTUS_WIDTH, height: cactusHeight });
                    
                    const interval = Math.random() * 80 + 70; // 70 to 150 frames
                    nextCactusFrame = frameCount + interval; 
                    
                    GAME_SPEED += 0.0005; // Gentle speed increase
                }
            };

            const checkCollision = () => {
                const dinoBox = {
                    x1: dino.x,
                    y1: dino.y,
                    x2: dino.x + DINO_SIZE,
                    y2: dino.y + DINO_SIZE
                };

                for (const obs of obstacles) {
                    const obsBox = {
                        x1: obs.x,
                        y1: GROUND_Y - obs.height,
                        x2: obs.x + obs.width,
                        y2: GROUND_Y
                    };

                    if (dinoBox.x1 < obsBox.x2 && dinoBox.x2 > obsBox.x1 &&
                        dinoBox.y1 < obsBox.y2 && dinoBox.y2 > obsBox.y1) {
                        return true;
                    }
                }
                return false;
            };

            // --- Main Loop ---
            const loop = () => {
                ctx.fillStyle = '#f7f7f7'; // Match classic theme background
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (isRunning) {
                    frameCount++;
                    score += 0.1;

                    updateDino();
                    updateObstacles();

                    if (checkCollision()) {
                        gameOver();
                        return;
                    }
                }
                
                // Draw everything
                drawGround();
                drawDino();
                obstacles.forEach(drawCactus);
                drawScore();
                
                if (isRunning) {
                    gameLoop = requestAnimationFrame(loop);
                }
            };
            
            // --- Game States ---
            const resetGame = () => {
                dino = { x: 20, y: GROUND_Y - DINO_SIZE, dy: 0, isJumping: false };
                obstacles = [];
                score = 0;
                frameCount = 0;
                GAME_SPEED = 4;
                isGameOver = false;
                isRunning = false;
                messageElement.textContent = 'T-REX: Press SPACE to Start';
                
                // Initial draw
                ctx.fillStyle = '#f7f7f7'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawGround();
                drawDino();
                drawScore();
                
                cancelAnimationFrame(gameLoop);
                gameLoop = requestAnimationFrame(loop); 
            };

            const startRunning = () => {
                if (!isRunning) {
                    isRunning = true;
                    isGameOver = false;
                    messageElement.textContent = 'RUNNING... Type EXIT to stop';
                    gameLoop = requestAnimationFrame(loop);
                }
            };

            const gameOver = () => {
                isGameOver = true;
                isRunning = false;
                messageElement.textContent = `GAME OVER! Score: ${Math.floor(score)}. Press SPACE to Restart.`;
                
                // Show "GAME OVER" in the canvas
                ctx.fillStyle = '#555';
                ctx.font = "20px 'VT323'";
                ctx.textAlign = 'center';
                ctx.fillText('G A M E   O V E R', CANVAS_W / 2, CANVAS_H / 2);

                gameSfxAudio.src = SOUND_EFFECTS.ALERT; 
                gameSfxAudio.play().catch(e => console.log("Game over sound failed:", e));
                cancelAnimationFrame(gameLoop);
            };
            
            const dinoJump = () => {
                if (!dino.isJumping) {
                    dino.isJumping = true;
                    dino.dy = JUMP_VELOCITY;
                    gameSfxAudio.src = SOUND_EFFECTS.CONFIRM;
                    gameSfxAudio.play().catch(e => console.log("Jump sound failed:", e));
                }
            };

            // --- Input Handler for Game ---
            const handleInput = (e) => {
                if (e.type === 'keydown' && (e.key === ' ' || e.key === 'ArrowUp')) {
                    e.preventDefault();
                    if (isGameOver) {
                        resetGame();
                        startRunning();
                    } else if (!isRunning) {
                        startRunning();
                    } else if (isRunning) {
                        dinoJump();
                    }
                }
            };
            
            resetGame(); 

            return { stop: () => { isRunning = false; cancelAnimationFrame(gameLoop); }, handleInput };
        }
        
        // =========================================================================
        // --- LOCAL LOCKDOWN LOGIC (Simplified) ---
        // =========================================================================
        
        function applyLockdownVisuals() {
            if (isLockedDown) return;
            isLockedDown = true;
            bodyElement.classList.add('lockdown-active');
            lockdownIndicator.style.display = 'inline';
            commandInput.disabled = true;

            if (sirenAudio) {
                sirenAudio.loop = true;
                sirenAudio.play().catch(e => console.log("Siren failed to auto-play:", e));
            }
        }

        function removeLockdownVisuals() {
            if (!isLockedDown) return;
            isLockedDown = false;
            bodyElement.classList.remove('lockdown-active');
            lockdownIndicator.style.display = 'none';
            commandInput.disabled = false;
            if (sirenAudio) sirenAudio.pause();
            
            writeOutput("\n>> LOCKDOWN PROTOCOL DISABLED. CONSOLE RESTORED.", '#00ff41');
            isBusy = false;
            showPrompt();
        }

        function startLockdown() {
            if (!isAdmin() || isLockedDown) {
                writeOutput(isLockedDown ? "System is already in lockdown." : "ERROR: Authorization denied (Admin Only).", '#ff0000');
                return;
            }
            
            isBusy = true;
            writeOutput("\n>>> INITIATING LOCAL LOCKDOWN SEQUENCE... <<<", '#ff0000');
            
            // Simulate processing delay
            setTimeout(() => {
                applyLockdownVisuals();
                writeOutput(">>> LOCAL LOCKDOWN SIGNAL INITIATED. Input blocked.", '#ff00ff');
                writeOutput("!! ACCESS GRANTED TO ADMIN: " + ADMIN_USERNAME.toUpperCase() + " !!", '#ff00ff');
                writeOutput("!! TYPE '?DISABLE' TO END LOCKDOWN !!", '#ff00ff');
                isBusy = false;
                commandInput.disabled = false; // Admin can still type to disable
                showPrompt();
            }, 1000);
        }
        
        function disableLockdown() {
            if (!isAdmin()) {
                writeOutput("ERROR: Authorization denied (Admin Only).", '#ff0000');
                return;
            }
            
            if (!isLockedDown) {
                writeOutput("System is not currently in lockdown.", '#00ff41');
                return;
            }

            isBusy = true;
            writeOutput("\n>> ATTEMPTING LOCKDOWN PROTOCOL DISENGAGEMENT...", '#00ff41');

            // Simulate processing delay
            setTimeout(() => {
                removeLockdownVisuals();
            }, 1000);
        }

        // =========================================================================
        // --- Feature Commands ---
        // =========================================================================

        function runPlayCommand(keyword) {
            const key = keyword.toUpperCase();

            // 1. Check for Game Command
            const gameKeys = Object.keys(GAMES).filter(k => k === key || GAMES[k].aliases.includes(key));
            if (gameKeys.length > 0) {
                startGame(gameKeys[0]);
                return;
            }

            // 2. Check for SFX Command
            if (!keyword || keyword.trim() === "") {
                writeOutput("--- AVAILABLE GAME ENGINES (Unblocked Classics) ---", '#ffff00');
                Object.keys(GAMES).forEach((k) => {
                    const gameDef = GAMES[k];
                    const aliases = gameDef.aliases.length > 0 ? ` (Aliases: ${gameDef.aliases.join(', ')})` : '';
                    writeOutput(`[GAME] : **${gameDef.name}**${aliases}`, '#00ff41');
                    writeOutput(`  - USAGE: PLAY ${k} | CONTROLS: ${gameDef.controls}`, '#00ffff');
                });

                writeOutput("\n--- AVAILABLE SFX KEYWORDS ---", '#ffff00');
                Object.keys(SOUND_EFFECTS).forEach(key => {
                    writeOutput(`[READY] : **${key}**`, '#00ff41');
                });
                writeOutput("\nUSAGE: PLAY [KEYWORD/GAME]", '#00ffff');
                if (!isBusy) showPrompt();
                return;
            }

            // SFX Logic
            
            if (SOUND_EFFECTS[key]) {
                const filename = SOUND_EFFECTS[key];
                isBusy = true;
                commandInput.disabled = true;
                writeOutput(`\nSearching Local SFX Index: **${key}**...`, '#00ffff');
                setTimeout(() => {
                    writeOutput(`>> Local Repository Successful! Initiating buffer: ${filename}`, '#00ff41');
                    sfxAudio.src = filename;
                    sfxAudio.play()
                        .then(() => {
                            sfxAudio.onended = () => {
                                sfxAudio.onended = null; 
                                isBusy = false;
                                commandInput.disabled = isLockedDown && !isAdmin();
                                showPrompt();
                            };
                        })
                        .catch(error => {
                            writeOutput(`ERROR: Failed to play sound '${key}'. (Autoplay block).`, '#ff0000');
                            isBusy = false;
                            commandInput.disabled = isLockedDown && !isAdmin();
                            showPrompt();
                        });
                }, SFX_SEARCH_TIME_MS);
            } else {
                writeOutput(`!! SEARCH FAILED: Keyword/Game **${key}** not found.`, '#ff0000');
                if (!isBusy) showPrompt();
            }
        }

        // =========================================================================
        // --- Main Command Processor ---
        // =========================================================================
        
        function processCommand(command) {
            const trimmedCommand = command.trim();
            const parts = trimmedCommand.split(/\s+/);
            const cmd = parts[0].toUpperCase();

            // --- Game Active Check ---
            if (isGameActive) {
                writeOutput(`> ${command}`, '#ff00ff');
                if (cmd === 'EXIT') {
                    endGame();
                } else {
                    writeOutput("!! CONSOLE BLOCKED: Game is active. Only **EXIT** is allowed as a command.", '#ff0000');
                }
                return;
            }
            
            // --- Lockdown Check (Admin Bypass/Disable) ---
            if (isLockedDown) {
                if (isAdmin() && cmd === '?DISABLE') {
                    writeOutput(`> ${command}`, '#ff00ff');
                    disableLockdown();
                    return;
                } else if (isAdmin() && cmd === '?LOCKDOWN') {
                     // Allow admin to re-issue lockdown command
                     writeOutput(`> ${command}`, '#ff00ff');
                     writeOutput("System is already in lockdown. Type '?DISABLE' to end.", '#ffff00');
                     return;
                }
                writeOutput(`> ${command}`, '#ff0000'); 
                writeOutput("!! ERROR: TERMINAL IS IN LOCKDOWN. COMMANDS BLOCKED. !!", '#ff0000');
                return;
            }
            
            // Check if system is busy 
            if (isBusy && !['LOGOUT'].includes(cmd) && !overrideActive) {
                writeOutput("!! System Busy. Please wait for current sequence to finish.", '#ff0000');
                return;
            }
            
            // --- LOCKDOWN Command Check (Initiation) ---
            if (cmd === '?LOCKDOWN' || cmd === 'LOCKDOWN') {
                writeOutput(`> ${command}`, '#ff00ff');
                startLockdown();
                return;
            }
            
            // --- All other commands ---
            writeOutput(`> ${command}`, (overrideActive ? '#ffcc00' : '#ff00ff')); 
            
            switch (cmd) {
                case 'HELP':
                    writeOutput("--- AVAILABLE ATLAS CONSOLE FEATURES (v5.5) ---", '#ffff00');
                    writeOutput("11. **PLAY** [sfx/game] : Initiate sound effect or game. **Type PLAY alone for list.**", '#ff00ff');
                    writeOutput("12. CLEANUP : Purge local console logs and session cache.", '#00ffff');
                    writeOutput("13. REBOOT : Soft reboot the console OS.", '#00ffff');
                    writeOutput("14. THEME [color] : Change console display color (BLUE/RED/DEFAULT).", '#00ffff');
                    writeOutput("15. LOGOUT: Terminates session and redirects to main page.", '#ff0000');
                    
                    // Display games
                    writeOutput("\n--- AVAILABLE GAME ENGINES (Unblocked Classics) ---", '#ffff00');
                    Object.keys(GAMES).forEach((key, index) => {
                        const gameDef = GAMES[key];
                        const aliases = gameDef.aliases.length > 0 ? ` (Aliases: ${gameDef.aliases.join(', ')})` : '';
                        writeOutput(`[GAME] : **${gameDef.name}** (Usage: PLAY ${key})${aliases}`, '#00ff41');
                    });
                    writeOutput(" ", '#00ff41'); // Spacer
                    
                    if (isAdmin()) {
                        writeOutput("16. **?LOCKDOWN**: [LOCAL] Initiates local security lockdown (Admin Only).", '#ff0000');
                        writeOutput("17. **SUDO**: Admin Alpha Override Protocol.", '#ffff00');
                    } else {
                        writeOutput("16. **SUDO**: Admin Alpha Override Protocol.", '#ffff00');
                    }
                    break;
                
                case 'PLAY': 
                    const keyword = trimmedCommand.substring(cmd.length).trim();
                    runPlayCommand(keyword); 
                    break;

                case 'SUDO':
                    if (!isAdmin()) {
                         writeOutput("ACCESS DENIED: SUDO privileges require LEVEL EXTREME clearance.", '#ff0000');
                         break;
                    }
                    if (overrideActive) {
                         writeOutput("ALPHA OVERRIDE is already active. No action needed.", '#ffff00');
                         break;
                    }
                    applyOverrideTheme();
                    writeOutput("\n*****************************************************", '#ff00ff');
                    writeOutput(">> LEVEL ALPHA OVERRIDE ACTIVATED. Welcome, Admin.", '#ffff00');
                    writeOutput("*****************************************************", '#ff00ff');
                    break;

                case 'LOGOUT':
                    writeOutput("SESSION TERMINATED. Redirecting to source...", '#ff0000');
                    // Changed default logout target to a non-Firebase URL since we removed Firebase
                    setTimeout(() => { window.location.href = 'https://google.com'; }, 1000); 
                    return;
                
                case 'THEME':
                    if (overrideActive) {
                        writeOutput("ERROR: Theme change blocked. System is running under ALPHA OVERRIDE.", '#ff0000');
                        break;
                    }
                    const newTheme = parts[1] ? parts[1].toUpperCase() : 'DEFAULT';
                    if (THEMES[newTheme]) {
                        bodyElement.classList.remove(THEMES[currentTheme].className);
                        bodyElement.classList.add(THEMES[newTheme].className);
                        currentTheme = newTheme;
                        consoleContainer.style.borderColor = THEMES[newTheme].mainColor;
                        consoleContainer.style.boxShadow = `0 0 10px ${THEMES[newTheme].mainColor}`;
                        writeOutput(`Theme set to ${newTheme}.`, THEMES[newTheme].mainColor);
                    } else {
                        writeOutput(`ERROR: Theme '${newTheme}' not found. Type THEME [BLUE/RED/DEFAULT].`, '#ff0000');
                    }
                    break;

                case 'REBOOT':
                case 'CLEANUP':
                    writeOutput(`Running Command: ${cmd}... [EXECUTION]`, '#00ff41');
                    break;
                
                case 'ACTIVE':
                    writeOutput("!! ACTIVE COMMAND DISABLED: Placeholder feature removed. !!", '#ffaa00');
                    break;
                
                default:
                    writeOutput(`ERROR: Command '${cmd}' not recognized. Type HELP for a list of features.`, '#ff0000');
                    break;
            }
            
            if (!isBusy && !isLockedDown) showPrompt();
        }

        // =========================================================================
        // --- Initialization and Events ---
        // =========================================================================
        
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !commandInput.disabled) {
                processCommand(commandInput.value);
                commandInput.value = '';
            }
        });
        
        window.onload = function() {
            document.body.addEventListener('click', unlockAudioContext, { once: true });
            document.body.addEventListener('keydown', unlockAudioContext, { once: true });

            commandInput.focus();
            
            writeOutput(`\nSFX/GAME DATABASE: Local repository initialized with ${Object.keys(SOUND_EFFECTS).length} assets and ${Object.keys(GAMES).length} game engines. All systems nominal.`, '#00ff41');
        };
    </script>
</body>
</html>
