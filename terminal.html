<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS: DATA FLOW CONSOLE v6.4</title>
    <!-- Use a Google Font for the retro terminal look -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* Define a CSS variable for easy theme changing */
        :root {
            --terminal-color: #00ff41; /* Default Green */
            --terminal-background-color: #000;
            --border-color: #00ff41;
            --prompt-caret: #ffaa00;
        }

        /* General Console Theme */
        body {
            background-color: var(--terminal-background-color);
            font-family: 'VT323', monospace;
            color: var(--terminal-color);
            font-size: 1.1rem;
            line-height: 1.4;
            height: 100vh;
            margin: 0;
            overflow: hidden; 
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; 
            transition: color 0.5s, border-color 0.5s, background-color 0.1s; 
        }

        /* --- Animated Background Layer --- */
        #terminal-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
            /* Simple scanline effect for retro feel */
            background-image: linear-gradient(rgba(0, 0, 0, 0.75) 1px, transparent 1px);
            background-size: 100% 2px;
            animation: flicker 0.15s infinite alternate;
        }

        @keyframes flicker {
            0% { opacity: 0.05; }
            50% { opacity: 0.1; }
            100% { opacity: 0.15; }
        }

        /* --- Main Terminal Window --- */
        #terminal-container {
            position: relative;
            z-index: 1;
            width: 95%;
            max-width: 800px;
            height: 80vh;
            max-height: 600px;
            border: 3px solid var(--border-color);
            padding: 15px; 
            padding-top: 40px; /* Space for the fixed header */
            box-shadow: 0 0 20px var(--border-color);
            background-color: rgba(0, 0, 0, 0.85); 
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--terminal-color) #111;
            
            /* Hidden by default, shown on successful login */
            display: none; 
        }

        /* --- Fixed Header Style --- */
        #terminal-header {
            position: absolute; 
            top: 0;
            left: 0;
            right: 0;
            padding: 8px 15px;
            background-color: rgba(0, 0, 0, 0.95); 
            border-bottom: 1px solid var(--border-color);
            z-index: 2; 
            font-size: 1rem;
            display: flex; 
            justify-content: space-between;
            height: 30px; 
            line-height: 1.5;
            flex-wrap: nowrap;
        }
        
        /* Spacing for header elements */
        #terminal-header span:nth-child(2) {
            margin-left: 10px; 
            margin-right: 10px;
        }

        /* Scrollbar styles (for Webkit browsers) */
        #terminal-container::-webkit-scrollbar {
            width: 8px;
        }
        #terminal-container::-webkit-scrollbar-thumb {
            background-color: var(--terminal-color);
        }
        #terminal-container::-webkit-scrollbar-track {
            background-color: #111;
        }

        /* --- Output and Prompt --- */
        #output-area {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 5px;
        }

        .prompt-line {
            display: flex;
            align-items: baseline;
            /* Ensures prompt input line wraps correctly */
            width: 100%; 
        }

        #prompt-symbol {
            color: var(--prompt-caret);
            margin-right: 5px;
            flex-shrink: 0; /* Prevents the prompt symbol from shrinking */
        }

        /* FIX: Ensure input takes all remaining space for native caret */
        #command-input {
            background: none;
            border: none;
            color: var(--terminal-color);
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            flex-grow: 1; /* Key to making it take remaining space */
            padding: 0;
            outline: none;
            caret-color: var(--prompt-caret); /* Use native blinking caret */
        }

        /* Removed #typing-indicator styles and @keyframes blink */

        /* --- LOGIN MODAL STYLES --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex; 
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        #login-card {
            border: 3px solid #ff0000; /* Red for locked status */
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            padding: 30px;
            background-color: #111;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-field {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-field label {
            display: block;
            margin-bottom: 5px;
            color: #ffaa00; /* Amber text for labels */
        }

        .login-field input {
            width: 100%;
            padding: 10px;
            background-color: #000;
            border: 1px solid #ff0000;
            color: #ffaa00;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            box-sizing: border-box;
            outline: none;
        }

        #login-button {
            background-color: #ff0000;
            color: #fff;
            border: 2px solid #ff0000;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            transition: background-color 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        #login-button:hover {
            background-color: #cc0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
        }

        #login-error {
            color: #ff0000;
            margin-top: 15px;
            height: 1.5rem; /* Reserve space */
        }
        
    </style>
</head>
<body>
    <div id="terminal-background"></div>
    
    <!-- LOGIN MODAL STRUCTURE -->
    <div id="login-overlay">
        <div id="login-card">
            <h2 style="color: #ff0000; margin-top: 0; margin-bottom: 20px;">ATLAS ACCESS PROTOCOL</h2>
            <p style="color: #ffaa00; font-size: 1rem;">STATUS: System Locked Down. Full Access Key Required.</p>
            <form id="login-form">
                <div class="login-field">
                    <label for="username">USERNAME:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="login-field">
                    <label for="password">PASSWORD:</label>
                    <input type="password" id="password" required>
                </div>
                <div class="login-field">
                    <label for="key">ACCESS KEY:</label>
                    <input type="text" id="key" required>
                </div>
                <button type="submit" id="login-button">INITIATE DATA FLOW UNLOCK</button>
            </form>
            <div id="login-error">Awaiting Authentication...</div>
        </div>
    </div>
    <!-- END LOGIN MODAL -->

    <div id="terminal-container">
        <div id="terminal-header"></div> <!-- FIXED HEADER FOR DATE/TIME/LOCATION -->
        <div id="output-area"></div>
        <div id="prompt-line" class="prompt-line" style="display: none;">
            <span id="prompt-symbol">ATLAS_CONSOLE ></span>
            <input type="text" id="command-input" autocomplete="off" autofocus>
            <!-- REMOVED: <span id="typing-indicator">|</span> -->
        </div>
    </div>

    <script>
        // =========================================================================
        // --- Core Console Variables and State ---
        // =========================================================================
        const outputArea = document.getElementById('output-area');
        const commandInput = document.getElementById('command-input');
        const promptLine = document.getElementById('prompt-line');
        const terminalContainer = document.getElementById('terminal-container');
        const terminalHeader = document.getElementById('terminal-header'); 
        
        // MODAL ELEMENTS
        const loginOverlay = document.getElementById('login-overlay');
        const loginForm = document.getElementById('login-form');
        const loginErrorDiv = document.getElementById('login-error');

        // Authentication & System State
        const USERNAME = 'ETHANUNLOCKED'; 
        const PASSWORD_HASH = 'h4cker';
        const ACCESS_KEY = '1957';

        let isLoggedIn = false;
        let accessLevel = 0; 
        let isBusy = false;
        let isLockedDown = true;
        let history = [];
        let historyIndex = -1;
        let audioContext;
        let audioBuffers = {};
        let timeInterval; 
        
        // Location State
        let systemLocation = 'RESOLVING LOCATION...'; 

        // =========================================================================
        // --- Audio/SFX Engine ---
        // =========================================================================
        
        const SOUND_EFFECTS = {
            'confirm': 'confirm.mp3',
            'alert': 'alert.mp3',
            'siren': 'siren.mp3',
            'get-out': 'get-out-meme.mp3',
            'vine-boom': 'vine-boom.mp3'
        };

        function unlockAudioContext() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            } catch (e) {
                console.error("Audio Context could not be initialized/unlocked:", e);
            }
        }

        async function loadSound(name, filename) {
             audioBuffers[name] = new Audio(filename);
        }

        function playSound(name) {
             if (audioBuffers[name]) {
                audioBuffers[name].currentTime = 0;
                audioBuffers[name].play().catch(e => console.warn(`Error playing ${name}:`, e));
             } else {
                console.log(`[SFX] Playing sound: ${name} (No audio element found)`);
             }
        }

        // =========================================================================
        // --- Game Engine Placeholders ---
        // =========================================================================
        const GAMES = {
            'SNAKE': {
                description: 'Classic single-player logic matrix game.',
                run: () => {
                    writeOutput('LOADING GAME: SNAKE. (Engine not yet implemented).', '#ffaa00');
                }
            },
            'MAZE': {
                description: '3D Wireframe navigation simulation.',
                run: () => {
                    writeOutput('LOADING GAME: MAZE. (Engine not yet implemented).', '#ffaa00');
                }
            }
        };

        // =========================================================================
        // --- Console Utility Functions ---
        // =========================================================================

        function writeOutput(text, color = 'var(--terminal-color)') {
            const line = document.createElement('div');
            line.innerHTML = text.replace(/\n/g, '<br>'); 
            line.style.color = color;
            outputArea.appendChild(line);
            terminalContainer.scrollTop = terminalContainer.scrollHeight;
        }
        
        function resolveLocation() {
            // 1. Get TimeZone first, as it's synchronous and reliable.
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            systemLocation = timeZone; // Default to TimeZone string

            // 2. Attempt Geolocation (async)
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(2);
                        const lon = position.coords.longitude.toFixed(2);
                        
                        // Display the zone name plus coordinates
                        systemLocation = `${timeZone} (${lat}, ${lon})`;
                        writeOutput(`[SYSTEM] Geolocation resolved. Coordinates: ${lat}, ${lon}`);
                    },
                    (error) => {
                        // If permission is denied or error occurs, stick with the TimeZone string
                        console.warn("Geolocation failed:", error.message);
                        writeOutput(`[SYSTEM] Geolocation failed (Code ${error.code}). Using TimeZone fallback: ${timeZone}`, '#ffaa00');
                        systemLocation = `${timeZone} (NO GEO DATA)`;
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                // Geolocation not supported, stick with the TimeZone string
                writeOutput(`[SYSTEM] Geolocation unsupported. Using TimeZone fallback: ${timeZone}`, '#ffaa00');
                systemLocation = `${timeZone} (UNSUPPORTED)`;
            }
        }


        function formatDateTimeHeader(includeVersion = true) {
            const now = new Date();
            // Use system-defined locale for automatic local time
            const localTimeStr = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const localDateStr = now.toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit' });
            
            // Display the resolved location
            const locationSpan = `<span style="color:var(--terminal-color);">LOC: ${systemLocation}</span>`;
            const timeSpan = `<span style="color:#00aaff;">D/T: ${localDateStr} ${localTimeStr}</span>`;
            
            if (includeVersion) {
                return `<span style="color:#ffaa00;">ATLAS V6.4</span> | ${locationSpan} | ${timeSpan}`;
            }
            return `${locationSpan} | ${timeSpan}`;
        }

        function updateHeaderClock() {
            terminalHeader.innerHTML = formatDateTimeHeader();
        }

        function startHeaderClock() {
            updateHeaderClock(); // Update immediately
            clearInterval(timeInterval); // Clear any old interval
            timeInterval = setInterval(updateHeaderClock, 1000); // Update every second
        }

        function showPrompt() {
            promptLine.style.display = 'flex';
            commandInput.disabled = false;
            commandInput.focus();
        }
        
        // --- Activation Function (Called after successful login) ---
        function activateConsole() {
            isLoggedIn = true;
            accessLevel = 2;
            isLockedDown = false;
            
            // 1. Hide the modal and show the console
            loginOverlay.style.display = 'none';
            terminalContainer.style.display = 'block';
            
            // 2. Change console theme to visually confirm unlock (Amber theme)
            document.documentElement.style.setProperty('--terminal-color', '#ffaa00');
            document.documentElement.style.setProperty('--border-color', '#ffaa00');
            document.documentElement.style.setProperty('--prompt-caret', '#00ff41');
            
            // 3. Start the clock and location resolution
            playSound('siren'); 
            resolveLocation(); // Initial async call to get location
            startHeaderClock(); // Start the persistent clock

            writeOutput('----------------------------------------------------', '#00ff41');
            writeOutput('<span style="color:#ffaa00;">PRIMARY KEY VALIDATED. SYSTEM UNLOCK INITIATED.</span>', '#ffaa00');
            writeOutput('ATLAS DATA FLOW CONSOLE V6.4: FULL ACCESS ENABLED.', '#ffaa00');
            writeOutput('Core security lockdown terminated. ACCESS LEVEL 2.', '#ffaa00');
            writeOutput('----------------------------------------------------', '#00ff41');
            showPrompt();
        }

        // --- Handle Modal Login Submission ---
        function handleLogin(event) {
            event.preventDefault();
            
            const inputUser = document.getElementById('username').value.trim().toUpperCase();
            const inputPass = document.getElementById('password').value.trim(); 
            const inputKey = document.getElementById('key').value.trim();

            if (inputUser === USERNAME && inputPass === PASSWORD_HASH && inputKey === ACCESS_KEY) {
                loginErrorDiv.textContent = 'AUTHENTICATION SUCCESSFUL. INITIATING DATA FLOW...';
                loginErrorDiv.style.color = '#00ff41';
                setTimeout(activateConsole, 1000); // Wait a moment before transition
                playSound('confirm');
            } else {
                let errorMsg = 'ACCESS DENIED: Invalid Credentials.';
                
                if (inputUser !== USERNAME) errorMsg = 'ACCESS DENIED: Invalid Username.';
                else if (inputPass !== PASSWORD_HASH) errorMsg = 'ACCESS DENIED: Invalid Password.';
                else if (inputKey !== ACCESS_KEY) errorMsg = 'ACCESS DENIED: Invalid Access Key.';
                
                loginErrorDiv.textContent = errorMsg;
                loginErrorDiv.style.color = '#ff0000';
                playSound('alert');
                setTimeout(() => { loginErrorDiv.textContent = 'Awaiting Authentication...'; }, 3000);
            }
        }
        
        // =========================================================================
        // --- Command Processing (Updated for SFX fix) ---
        // =========================================================================

        function processCommand(input) {
            if (isLockedDown) return; 
            
            // Trim and sanitize input
            const sanitizedInput = input.trim();
            if (sanitizedInput === '') { showPrompt(); return; }

            writeOutput(`<span style="color:var(--prompt-caret);">ATLAS_CONSOLE ></span> ${sanitizedInput}`, 'var(--terminal-color)');
            
            if (history.length === 0 || history[history.length - 1] !== sanitizedInput) {
                history.push(sanitizedInput);
            }
            historyIndex = history.length;

            if (isBusy) {
                writeOutput('SYSTEM BUSY: Please wait for current operation to complete.', '#ffaa00');
                showPrompt();
                return;
            }
            
            isBusy = true;
            commandInput.disabled = true;

            const commandParts = sanitizedInput.toUpperCase().split(/\s+/);
            const cmd = commandParts[0];
            const args = commandParts.slice(1);
            let success = true;

            setTimeout(() => {
                const sfxKey = cmd.toLowerCase().replace('-', '');

                switch (cmd) {
                    case 'HELP':
                        writeOutput('----------------------------------------------------');
                        writeOutput('ATLAS CONSOLE COMMAND LIST:');
                        writeOutput('----------------------------------------------------');
                        writeOutput('<span style="color:#ffaa00;">CORE OPERATIONS:</span>');
                        writeOutput(`  <span style="color:var(--terminal-color);">EXECUTE [OP]</span>     - Run a critical data operation.`);
                        writeOutput(`  <span style="color:var(--terminal-color);">CLEAR</span>            - Clears the console screen.`);
                        writeOutput(`  <span style="color:var(--terminal-color);">STATUS</span>           - Displays current system status and access level.`);
                        writeOutput(`  <span style="color:var(--terminal-color);">TIME</span>             - Displays current system date and time/location.`); 
                        writeOutput('<span style="color:#ffaa00;">ENTERTAINMENT/SFX:</span>');
                        writeOutput(`  <span style="color:var(--terminal-color);">GAME [NAME]</span>      - Initiates a game engine (SNAKE, MAZE).`);
                        writeOutput(`  <span style="color:var(--terminal-color);">PLAY [SFX]</span>       - Trigger sound effects (Type PLAY for list).`);
                        writeOutput('----------------------------------------------------');
                        writeOutput(`CURRENT LOCKDOWN STATUS: <span style="color:#00ff41;">UNLOCKED</span> (LEVEL 2 ACCESS)`);
                        break;
                    
                    case 'TIME': 
                        writeOutput(`Current system time and status:`);
                        writeOutput(formatDateTimeHeader(false), '#00ff41'); 
                        break;

                    case 'STATUS':
                        writeOutput('----------------------------------------------------');
                        writeOutput('SYSTEM STATUS: <span style="color:#00ff41;">OPERATIONAL</span>');
                        writeOutput(`AUTH LEVEL: 2 (FULL ACCESS - ${USERNAME})`);
                        writeOutput('----------------------------------------------------');
                        break;
                        
                    case 'GAME':
                        if (args.length === 0) {
                            writeOutput('SYNTAX ERROR: GAME requires a name. Available games:', '#ff0000');
                            Object.keys(GAMES).forEach(game => writeOutput(`  - ${game}: ${GAMES[game].description}`));
                            break;
                        }
                        const gameName = args[0];
                        if (GAMES[gameName]) {
                            GAMES[gameName].run();
                        } else {
                            writeOutput(`ERROR: Game '${gameName}' not found. Type GAME for a list.`, '#ff0000');
                            success = false;
                        }
                        break;

                    case 'PLAY':
                        if (args.length === 0) {
                            writeOutput('SYNTAX ERROR: PLAY requires an SFX name. Available SFX:', '#ff0000');
                            Object.keys(SOUND_EFFECTS).forEach(sfxKey => {
                                writeOutput(`  - <span style="color:var(--terminal-color);">${sfxKey.toUpperCase().replace('-', '_')}</span>`); 
                            });
                            success = false;
                            break;
                        }
                        const playSfx = args[0].toLowerCase().replace('-', ''); 
                        if (SOUND_EFFECTS[playSfx] || (playSfx === 'getout' || playSfx === 'vineboom')) {
                            playSound(playSfx);
                        } else {
                            writeOutput(`ERROR: SFX '${args[0]}' not recognized. Type PLAY for a list.`, '#ff0000');
                            success = false;
                        }
                        break;

                    case 'EXECUTE':
                        if (args.length === 0) {
                            writeOutput('SYNTAX ERROR: EXECUTE requires an operation. Type HELP for available commands.', '#ff0000');
                            success = false;
                            break;
                        }
                        writeOutput(`EXECUTING CRITICAL OPERATION: [${args.join(' ')}]`, '#00ff41');
                        break;

                    case 'CLEAR':
                        outputArea.innerHTML = '';
                        break;
                    
                    default:
                        // FIX: Check if the unrecognised command is actually a sound effect name
                        if (SOUND_EFFECTS[sfxKey] || (sfxKey === 'getout' || sfxKey === 'vineboom')) {
                             writeOutput(`SYNTAX ERROR: SFX must be run with the <span style="color:#00aaff;">PLAY</span> command. Use: <span style="color:#00aaff;">PLAY ${cmd}</span>`, '#ff0000');
                        } else {
                             writeOutput(`ERROR: Command '${cmd}' not recognized. Type HELP for a list of features.`, '#ff0000');
                        }
                        success = false;
                        break;
                }
                
                isBusy = false;
                if (!isLockedDown) showPrompt();
            }, 200); 
        }

        // =========================================================================
        // --- Initialization and Events ---
        // =========================================================================
        
        // Modal Form Submission Handler
        loginForm.addEventListener('submit', handleLogin);
        
        // Terminal Input Handlers
        document.addEventListener('keypress', function(e) {
            if (!isLockedDown && e.key === 'Enter' && !commandInput.disabled) {
                processCommand(commandInput.value);
                commandInput.value = '';
            }
        });
        
        // Handle history navigation (Up/Down arrow keys)
        document.addEventListener('keydown', function(e) {
            if (commandInput.disabled || isLockedDown) return;

            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (history.length > 0 && historyIndex > 0) {
                    historyIndex--;
                    commandInput.value = history[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    commandInput.value = history[historyIndex];
                } else {
                    historyIndex = history.length;
                    commandInput.value = '';
                }
            }
        });

        window.onload = function() {
            // Unlocking the Audio Context requires user interaction (click/key)
            document.body.addEventListener('click', unlockAudioContext, { once: true });
            document.body.addEventListener('keydown', unlockAudioContext, { once: true });
            
            // Load audio assets in the background
            Object.keys(SOUND_EFFECTS).forEach(name => loadSound(name, SOUND_EFFECTS[name]));

            // Ensure the input field in the modal is focused on load
            document.getElementById('username').focus();
        };
    </script>

</body></html>
