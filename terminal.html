<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS: DATA FLOW CONSOLE v5.3 (REAL-TIME LOCKDOWN)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* General Console Theme */
        body {
            background-color: #000;
            font-family: 'VT323', monospace;
            color: #00ff41; /* Console Green (Default) */
            font-size: 1.1rem;
            line-height: 1.4;
            height: 100vh;
            margin: 0;
            overflow: hidden; 
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; 
            transition: color 0.5s, border-color 0.5s, background-color 0.1s; 
        }

        /* --- Animated Background Layer --- */
        #terminal-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; 
            background-size: cover;
            background-position: center;
            opacity: 0.3; 
            filter: grayscale(100%) brightness(50%); 
            transition: background-image 0.5s ease, filter 0.5s, opacity 0.5s;
            background-image: url('main.gif'); /* Placeholder image */
        }

        /* Simulated CRT/Scanline Effect */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                #000, 
                #000 1px, 
                rgba(0, 255, 65, 0.08) 2px, 
                #000 3px
            );
            opacity: 0.8;
            z-index: -1;
            transition: background 0.5s;
        }

        /* --- LOCKDOWN EFFECT CSS --- */
        .lockdown-active {
            background-color: #500000 !important; 
            color: #ff0000 !important; 
        }
        .lockdown-active .console-container {
            border-color: #ff0000 !important;
            box-shadow: 0 0 15px #ff0000 !important;
            animation: lockdown-flash 0.1s infinite alternate; 
        }
        .lockdown-active body::before {
            background: repeating-linear-gradient(#500000, #500000 1px, rgba(255, 0, 0, 0.15) 2px, #500000 3px);
            opacity: 1;
        }
        @keyframes lockdown-flash {
            from { opacity: 1; }
            to { opacity: 0.8; }
        }
        /* --- End LOCKDOWN EFFECT CSS --- */


        .console-container {
            border: 3px solid #00ff41; 
            box-shadow: 0 0 10px #00ff41; 
            height: 95vh;
            display: flex;
            flex-direction: column;
            margin: 10px auto;
            max-width: 1000px;
            width: 95%; 
            position: relative; 
            transition: transform 0.1s ease-in-out, border-color 0.5s, box-shadow 0.5s; 
        }

        /* Output Area */
        #output-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.9);
            white-space: pre-wrap;
        }

        /* Input Area */
        #input-line {
            padding: 1rem;
            border-top: 1px solid; /* Handled by theme color */
            display: flex;
            transition: border-top 0.5s;
        }

        #input-prefix {
            color: #ff00ff; 
        }

        #command-input {
            background: transparent;
            border: none;
            color: inherit; 
            flex-grow: 1;
            outline: none;
            margin-left: 5px;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
        }
        
        /* Status Bar */
        #status-bar {
            background: #004d1a;
            color: #fff;
            padding: 0.5rem 1rem;
            text-align: right;
            font-size: 0.9rem;
            transition: background 0.5s;
        }
        
        /* THEME & Holiday Styles (Simplified) */
        .blue-theme { color: #00d0ff; }
        .red-theme { color: #ff3030; }
        .blue-theme .console-container { border-color: #00d0ff; box-shadow: 0 0 10px #00d0ff; }
        .red-theme .console-container { border-color: #ff3030; box-shadow: 0 0 10px #ff3030; }
        
    </style>
</head>
<body>
    
    <!-- Audio Placeholder (You need to provide hack.mp3, siren.mp3, and SFX files) -->
    <audio id="main-music" loop preload="auto" volume="1.0">
        <source src="hack.mp3" type="audio/mp3">
    </audio>
    <audio id="siren-audio" preload="auto">
        <source src="siren.mp3" type="audio/mp3">
    </audio>
    <!-- New Reusable Audio Player for Sound Effects -->
    <audio id="sfx-audio" preload="auto"></audio>
    
    <div id="terminal-background"></div>

    <div class="console-container">
        
        <div id="status-bar">
            <!-- UPDATED: Instant Status -->
            <span id="sound-status" style="color: #00ff41; float: left; margin-right: 20px;">[SFX DATABASE ONLINE]</span>
            
            <span id="lockdown-indicator" style="color: #ff0000; float: left; display: none;">[LOCKDOWN ACTIVE]</span>
            <span id="override-indicator" style="color: #ffff00; float: left; display: none; margin-right: 20px;">[ALPHA OVERRIDE]</span>
            ATLAS CONSOLE v5.3 | OPERATOR: E.I. | <span id="auth-status">INITIATING AUTH...</span> | DATABASE: FIRESTORE
        </div>

        <div id="output-area">
            [[INITIATING ACCESS. . .]]<br>
            [[WELCOME, OPERATOR. LEVEL EXTREME CLEARANCE CONFIRMED.]]<br>
            <br>
            Type **HELP** for available commands.
            <br>
        </div>

        <div id="input-line">
            <span id="input-prefix">ATLAS ></span>
            <input type="text" id="command-input" autofocus>
        </div>
        
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & CONSTANTS ---
        const outputArea = document.getElementById('output-area');
        const commandInput = document.getElementById('command-input');
        const consoleContainer = document.querySelector('.console-container');
        const bodyElement = document.body; 
        const lockdownIndicator = document.getElementById('lockdown-indicator');
        const overrideIndicator = document.getElementById('override-indicator');
        const sirenAudio = document.getElementById('siren-audio'); 
        const inputPrefix = document.getElementById('input-prefix');
        const sfxAudio = document.getElementById('sfx-audio'); 
        const authStatus = document.getElementById('auth-status'); 

        let isBusy = false; 
        let isLockedDown = false; 
        let overrideActive = false; 
        let isFirebaseEnabled = false; // NEW FLAG: tracks if Firebase is initialized

        const ADMIN_USERNAME = "EthanUnlocked"; 
        const SFX_SEARCH_TIME_MS = 3000; 

        // --- FIREBASE INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'initializing';
        let isAuthReady = false; 
        
        // Firestore Path for the global state (Public data)
        const LOCKDOWN_DOC_PATH = `/artifacts/${appId}/public/data/console-state/lockdown-status`;

        // --- THEME DATA ---
        const THEMES = {
            'DEFAULT': { className: '', mainColor: '#00ff41' },
            'BLUE': { className: 'blue-theme', mainColor: '#00d0ff' },
            'RED': { className: 'red-theme', mainColor: '#ff3030' },
            'OVERRIDE': { className: 'override-theme', mainColor: '#ffff00' }
        };
        let currentTheme = 'DEFAULT';

        // --- SOUND EFFECT LIBRARY ---
        const SOUND_EFFECTS = {
            'GET OUT': 'get_out_meme.mp3', 
            'VINE-BOOM': 'vine-boom.mp3', 
            'ALERT': 'alert.mp3', 
            'CONFIRM': 'confirm.mp3', 
        };

        // =========================================================================
        // --- Utility Functions ---
        // =========================================================================

        function writeOutput(text, color = THEMES[currentTheme].mainColor) {
            const line = document.createElement('span');
            line.style.color = color;
            line.innerHTML = text; 
            outputArea.appendChild(line);
            outputArea.appendChild(document.createElement('br'));
            outputArea.scrollTop = outputArea.scrollHeight;
        }

        function showPrompt() {
            if (isLockedDown && !isAdmin()) return; 
            if (!isBusy) {
                writeOutput("", THEMES[currentTheme].mainColor);
            }
            commandInput.focus();
            commandInput.value = '';
        }

        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i <ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) === 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
        
        function getUsername() {
            return getCookie('username').trim();
        }
        
        function isAdmin() {
            return getUsername().toLowerCase() === ADMIN_USERNAME.toLowerCase();
        }
        
        function applyOverrideTheme() {
            bodyElement.style.color = '#ffff00'; 
            consoleContainer.style.borderColor = '#ffff00';
            consoleContainer.style.boxShadow = '0 0 15px #ffff00, 0 0 30px rgba(255, 255, 0, 0.5)';
            inputPrefix.style.color = '#ff00ff'; 
            
            document.getElementById('status-bar').style.backgroundColor = '#4d4d00'; 
            overrideIndicator.style.display = 'inline'; 
            
            overrideActive = true;
            currentTheme = 'OVERRIDE';
            isBusy = false; 
        }
        
        // --- AUDIO UNLOCK FUNCTION (for Autoplay Policy) ---
        let audioContextUnlocked = false;
        function unlockAudioContext() {
            if (audioContextUnlocked) return;
            sfxAudio.muted = true;
            sfxAudio.play().catch(e => {
                console.log("Initial audio unlock attempt failed (expected on first load):", e);
            }).finally(() => {
                sfxAudio.pause();
                sfxAudio.muted = false;
            });
            audioContextUnlocked = true;
            document.body.removeEventListener('click', unlockAudioContext);
            document.body.removeEventListener('keydown', unlockAudioContext);
        }

        // =========================================================================
        // --- FIREBASE / AUTH Initialization ---
        // =========================================================================
        async function initializeFirebase() {
            authStatus.textContent = 'AUTHENTICATING...';
            
            // NEW CHECK: Validate Firebase configuration
            if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId.length < 5) {
                authStatus.textContent = 'STATUS: DB DISABLED';
                writeOutput(`\n!!! CRITICAL FIREBASE ERROR: Missing 'projectId' in configuration. Database access is disabled.`, '#ff0000');
                writeOutput(`!!! LOCKDOWN command requires a functional Firebase connection.`, '#ff0000');
                isFirebaseEnabled = false;
                isAuthReady = true;
                showPrompt(); 
                return; // Exit initialization
            }

            isFirebaseEnabled = true; // Firebase configuration seems valid

            try {
                // setLogLevel('debug'); // Use this for debugging Firebase issues
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token if available, otherwise anonymously
                if (initialAuthToken) { 
                    await signInWithCustomToken(auth, initialAuthToken); 
                } else { 
                    await signInAnonymously(auth); 
                }

                // Listen for Auth State Changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        authStatus.textContent = `UID: ${userId.substring(0, 8)}...`;
                        writeOutput(`\nFIREBASE: Authenticated successfully. User ID: ${userId.substring(0, 12)}...`, '#00ffff');
                        listenForLockdown();
                        if (!isLockedDown) showPrompt(); // Show prompt only if not in lockdown and auth is ready
                    } else {
                        userId = 'anonymous';
                        authStatus.textContent = 'STATUS: ANON';
                        isAuthReady = true;
                        listenForLockdown();
                        if (!isLockedDown) showPrompt();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                authStatus.textContent = 'STATUS: ERROR';
                writeOutput(`\n!!! CRITICAL FIREBASE ERROR: ${error.message} !!!`, '#ff0000');
                isFirebaseEnabled = false; // Disable on runtime failure too
            }
        }
        
        // =========================================================================
        // --- LOCKDOWN Logic (Real-Time) ---
        // =========================================================================

        function applyLockdownVisuals() {
            if (isLockedDown) return;
            isLockedDown = true;
            bodyElement.classList.add('lockdown-active');
            lockdownIndicator.style.display = 'inline';
            commandInput.disabled = true;

            if (sirenAudio) {
                sirenAudio.loop = true;
                sirenAudio.play().catch(e => console.log("Siren failed to auto-play:", e));
            }
        }

        function removeLockdownVisuals() {
            if (!isLockedDown) return;
            isLockedDown = false;
            bodyElement.classList.remove('lockdown-active');
            lockdownIndicator.style.display = 'none';
            commandInput.disabled = false;
            if (sirenAudio) sirenAudio.pause();
            
            writeOutput("\n>> LOCKDOWN PROTOCOL DISABLED. CONSOLE RESTORED.", '#00ff41');
            isBusy = false;
            showPrompt();
        }

        function kickUserDueToLockdown() {
            applyLockdownVisuals();
            outputArea.innerHTML = '';
            writeOutput("!!! CRITICAL ALERT !!! GLOBAL LOCKDOWN INITIATED!", '#ff0000');
            writeOutput("!!! NON-ADMIN ACCESS REVOKED !!!", '#ff0000');
            
            // Redirect non-admin users
            setTimeout(() => {
                window.location.href = 'https://ethanunlocked690.github.io'; 
            }, 3000); 
        }

        async function listenForLockdown() {
            if (!isFirebaseEnabled || !db) return; // Guard clause

            const lockdownRef = doc(db, LOCKDOWN_DOC_PATH);

            onSnapshot(lockdownRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const newLockdownState = data.isLockedDown === true;

                    if (newLockdownState && !isLockedDown) {
                        // Lockdown activated by an admin
                        if (isAdmin()) {
                            applyLockdownVisuals();
                            commandInput.disabled = false; // Admin remains active
                            writeOutput("\n!! WARNING: SYSTEM IS IN GLOBAL LOCKDOWN MODE !!", '#ffff00');
                            writeOutput(`!! ACCESS GRANTED TO ADMIN: ${ADMIN_USERNAME.toUpperCase()} !!`, '#ff00ff');
                            writeOutput("!! TYPE '?DISABLE' TO END LOCKDOWN !!", '#ff00ff');
                        } else {
                            kickUserDueToLockdown();
                        }
                    } else if (!newLockdownState && isLockedDown) {
                        // Lockdown disabled by an admin
                        removeLockdownVisuals();
                    }
                } else if (isLockedDown) {
                    // Document doesn't exist but we think we're locked down (reset client state)
                    removeLockdownVisuals();
                }
            }, (error) => {
                console.error("Error listening to lockdown state:", error);
                writeOutput("!! REAL-TIME ERROR: Cannot monitor global status. !!", '#ff0000');
            });
            
            // Initial check in case the listener takes time to fire
            const initialDoc = await getDoc(lockdownRef);
            if (initialDoc.exists() && initialDoc.data().isLockedDown === true && !isAdmin()) {
                 kickUserDueToLockdown();
            }
        }
        
        async function startLockdown() {
            if (!isFirebaseEnabled) {
                writeOutput("ERROR: Database connection failed. Lockdown command disabled.", '#ff0000');
                return;
            }
            if (!isAdmin()) {
                writeOutput("ERROR: Authorization denied or database not ready.", '#ff0000');
                return;
            }
            if (isLockedDown) {
                writeOutput("System is already in lockdown.", '#ffaa00');
                return;
            }
            
            isBusy = true;
            writeOutput("\n>>> INITIATING LOCKDOWN SEQUENCE... <<<", '#ff0000');

            try {
                await setDoc(doc(db, LOCKDOWN_DOC_PATH), { 
                    isLockedDown: true, 
                    initiatedBy: userId, 
                    timestamp: new Date().toISOString() 
                }, { merge: true });
                
                // The 'onSnapshot' listener will handle applying visuals for the admin
                writeOutput(">>> GLOBAL LOCKDOWN SIGNAL BROADCAST. <<<", '#ff00ff');
            } catch (e) {
                writeOutput(`!!! DB WRITE FAILED: Could not initiate lockdown. Error: ${e.message}`, '#ff0000');
                isBusy = false;
                showPrompt();
            }
        }
        
        async function disableLockdown() {
            if (!isFirebaseEnabled) {
                 writeOutput("ERROR: Database connection failed. Cannot disable non-existent lockdown.", '#ff0000');
                 return;
            }
            if (!isAdmin()) {
                writeOutput("ERROR: Authorization denied or database not ready.", '#ff0000');
                return;
            }
            
            isBusy = true;
            writeOutput("\n>> ATTEMPTING LOCKDOWN PROTOCOL DISENGAGEMENT...", '#00ff41');

            try {
                await setDoc(doc(db, LOCKDOWN_DOC_PATH), { 
                    isLockedDown: false,
                    disabledBy: userId,
                    timestamp: new Date().toISOString() 
                }, { merge: true });
                
                writeOutput(">> GLOBAL LOCKDOWN SIGNAL CLEARED. Waiting for clients to reset...", '#00ffff');
            } catch (e) {
                writeOutput(`!!! DB WRITE FAILED: Could not disable lockdown. Error: ${e.message}`, '#ff0000');
                isBusy = false;
                showPrompt();
            }
        }

        // =========================================================================
        // --- Feature Commands ---
        // =========================================================================

        function runPlayCommand(keyword) {
            
            if (!keyword || keyword.trim() === "") {
                writeOutput("--- AVAILABLE SFX KEYWORDS (Case/Space/Hyphen Sensitive) ---", '#ffff00');
                
                Object.keys(SOUND_EFFECTS).forEach(key => {
                    writeOutput(`[READY] : **${key}**`, '#00ff41');
                });
                
                writeOutput("\nUSAGE: PLAY [KEYWORD] (e.g., PLAY VINE-BOOM)", '#00ffff');
                if (!isBusy) showPrompt();
                return;
            }
            
            const key = keyword.toUpperCase();

            // 1. Initiate search and busy state
            isBusy = true;
            commandInput.disabled = true;

            writeOutput(`\nSearching Global SFX Index & Mirror: **${key}**...`, '#00ffff');
            writeOutput(`**ESTIMATED SEARCH TIME: ${SFX_SEARCH_TIME_MS / 1000} SECONDS**`, '#ffff00'); 
            
            // --- SIMULATED SEARCH/DOWNLOAD DELAY (3 seconds) ---
            setTimeout(() => {
                
                if (SOUND_EFFECTS[key]) {
                    const filename = SOUND_EFFECTS[key];
                    
                    writeOutput(`>> Deep Web Search Successful! File located. Initiating buffer: ${filename}`, '#00ff41');

                    // 3. Play the audio
                    sfxAudio.src = filename;
                    sfxAudio.play()
                        .then(() => {
                            sfxAudio.onended = () => {
                                sfxAudio.onended = null; 
                                isBusy = false;
                                commandInput.disabled = !isLockedDown || isAdmin();
                                showPrompt();
                            };
                        })
                        .catch(error => {
                            writeOutput(`ERROR: Failed to play sound '${key}'. (Autoplay block: Console requires user interaction for audio).`, '#ff0000');
                            isBusy = false;
                            commandInput.disabled = !isLockedDown || isAdmin();
                            showPrompt();
                        });

                } else {
                    writeOutput(`!! SEARCH FAILED: Keyword **${key}** not found on MyInstants mirror.`, '#ff0000');
                    isBusy = false;
                    commandInput.disabled = !isLockedDown || isAdmin();
                    showPrompt();
                }

            }, SFX_SEARCH_TIME_MS); 
        }

        // =========================================================================
        // --- Main Command Processor ---
        // =========================================================================
        
        function processCommand(command) {
            const trimmedCommand = command.trim();
            const parts = trimmedCommand.split(/\s+/);
            const cmd = parts[0].toUpperCase();
            
            // --- Lockdown Check (Admin Bypass/Disable) ---
            if (isLockedDown) {
                if (isAdmin() && cmd === '?DISABLE') {
                    writeOutput(`> ${command}`, '#ff00ff');
                    disableLockdown();
                    return;
                }
                writeOutput(`> ${command}`, '#ff0000'); 
                writeOutput("!! ERROR: TERMINAL IS IN LOCKDOWN. COMMANDS BLOCKED. !!", '#ff0000');
                return;
            }
            
            // Check if system is busy (Bypassed if Alpha Override is active)
            if (isBusy && cmd !== 'LOGOUT' && cmd !== '?LOCKDOWN' && cmd !== 'LOCKDOWN' && !overrideActive) {
                writeOutput("!! System Busy. Please wait for current sequence to finish.", '#ff0000');
                return;
            }
            
            // --- LOCKDOWN Command Check (Initiation) ---
            if (cmd === '?LOCKDOWN' || cmd === 'LOCKDOWN') {
                writeOutput(`> ${command}`, '#ff00ff');
                startLockdown();
                return;
            }
            
            // --- All other commands ---
            writeOutput(`> ${command}`, (overrideActive ? '#ffcc00' : '#ff00ff')); 
            
            switch (cmd) {
                case 'HELP':
                    writeOutput("--- AVAILABLE ATLAS CONSOLE FEATURES (v5.3) ---", '#ffff00');
                    writeOutput("11. **PLAY** [sfx_key] : Initiate sound effect. **Type PLAY alone for list.**", '#ff00ff');
                    writeOutput("12. CLEANUP : Purge local console logs and session cache.", '#00ffff');
                    writeOutput("13. REBOOT : Soft reboot the console OS.", '#00ffff');
                    writeOutput("14. THEME [color] : Change console display color (BLUE/RED/DEFAULT).", '#00ffff');
                    writeOutput("15. **ACTIVE** : See the log of unique visitors on the site.", '#00ffff');
                    writeOutput("16. LOGOUT: Terminates session and redirects to main page.", '#ff0000');
                    
                    if (isAdmin()) {
                        if (isFirebaseEnabled) {
                            writeOutput("17. **?LOCKDOWN**: [ADMIN/FIRESTORE] Initiates global security lockdown.", '#ff0000');
                        } else {
                            writeOutput("17. **?LOCKDOWN**: [DISABLED] Database not connected.", '#ffaa00');
                        }
                        writeOutput("18. **SUDO**: (Hidden Command) Admin Alpha Override Protocol.", '#ffff00');
                    } else {
                        writeOutput("17. **SUDO**: (Hidden Command) Admin Alpha Override Protocol.", '#ffff00');
                    }
                    break;
                
                case 'ACTIVE':
                    // Note: 'ACTIVE' log functionality is local and requires the VISITOR_LOG_KEY implementation 
                    // which was removed to prioritize Firebase lockdown. Placeholder only.
                    writeOutput("!! ACTIVE COMMAND DISABLED: Functionality migrated to Firebase/private storage.", '#ffaa00');
                    break;
                
                case 'PLAY': 
                    const keyword = trimmedCommand.substring(cmd.length).trim();
                    runPlayCommand(keyword); 
                    break;

                case 'SUDO':
                    if (!isAdmin()) {
                         writeOutput("ACCESS DENIED: SUDO privileges require LEVEL EXTREME clearance.", '#ff0000');
                         break;
                    }
                    if (overrideActive) {
                         writeOutput("ALPHA OVERRIDE is already active. No action needed.", '#ffff00');
                         break;
                    }
                    applyOverrideTheme();
                    writeOutput("\n*****************************************************", '#ff00ff');
                    writeOutput(">> LEVEL ALPHA OVERRIDE ACTIVATED. Welcome, Admin.", '#ffff00');
                    writeOutput("*****************************************************", '#ff00ff');
                    break;


                case 'LOGOUT':
                    writeOutput("SESSION TERMINATED. Redirecting to source...", '#ff0000');
                    setTimeout(() => { window.location.href = 'https://ethanunlocked690.github.io'; }, 1000);
                    return;
                
                case 'THEME':
                    if (overrideActive) {
                        writeOutput("ERROR: Theme change blocked. System is running under ALPHA OVERRIDE.", '#ff0000');
                        break;
                    }
                    const newTheme = parts[1] ? parts[1].toUpperCase() : 'DEFAULT';
                    if (THEMES[newTheme]) {
                        bodyElement.classList.remove(THEMES[currentTheme].className);
                        bodyElement.classList.add(THEMES[newTheme].className);
                        currentTheme = newTheme;
                        consoleContainer.style.borderColor = THEMES[newTheme].mainColor;
                        consoleContainer.style.boxShadow = `0 0 10px ${THEMES[newTheme].mainColor}`;
                        writeOutput(`Theme set to ${newTheme}. (Placeholder)`, THEMES[newTheme].mainColor);
                    } else {
                        writeOutput(`ERROR: Theme '${newTheme}' not found.`, '#ff0000');
                    }
                    break;

                // --- Placeholder for other commands ---
                case 'REBOOT':
                case 'CLEANUP':
                case 'SEARCH':
                case 'DECRYPT':
                case 'SCAN':
                case 'HUNT':
                case 'TRACE':
                case 'DEFACE':
                case 'ENCRYPT':
                case 'PINGFLOOD':
                case 'SPOOF':
                case 'FAKE': 
                    writeOutput(`Running Command: ${cmd}... [PLACEHOLDER EXECUTION]`, '#00ff41');
                    break;
                
                default:
                    writeOutput(`ERROR: Command '${cmd}' not recognized. Type HELP for a list of features.`, '#ff0000');
                    break;
            }
            
            if (!isBusy && !isLockedDown) showPrompt();
        }

        // =========================================================================
        // --- Initialization and Events ---
        // =========================================================================
        
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !commandInput.disabled) {
                processCommand(commandInput.value);
                commandInput.value = '';
            }
        });
        
        window.onload = function() {
            // Attach the unlock function to the first click/keypress on the entire page
            document.body.addEventListener('click', unlockAudioContext, { once: true });
            document.body.addEventListener('keydown', unlockAudioContext, { once: true });
            
            // 1. Initialize Firebase
            initializeFirebase(); 

            // 2. Focus input
            commandInput.focus();
            
            writeOutput(`\nSFX DATABASE: Local repository initialized with ${Object.keys(SOUND_EFFECTS).length} assets. All systems nominal.`, '#00ff41');
        };
    </script>
</body>
</html>
