<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Geometry Dash Level Creator Club - Book a session</title>
    <style>
        /* --- üé® ADVANCED CSS STYLING (Cool Theme) --- */
        :root {
            --color-primary: #32CD32; /* Lime Green (GD Color) */
            --color-secondary: #00BFFF; /* Deep Blue */
            --color-dark: #1C1C1C;
            --color-light: #F0F0F0;
            --color-error: #FF4500;
            --color-cancel: #708090; /* Slate Gray for Cancellation */
            --font-main: 'Arial', sans-serif;
            --color-confirmed: #008000; /* Dark Green for Confirmed */
            --color-declined: #DC143C; /* Crimson for Declined */
            --color-pending: #FFD700; /* Gold for Pending */
        }

        body {
            font-family: var(--font-main);
            background-image: url('geometry.gif');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center; 
            background-attachment: fixed; 
            background-color: #1C1C1C; 
            color: var(--color-light);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px 0;
            margin: 0;
        }

        .container {
            background-color: rgba(30, 30, 30, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 0 5px var(--color-primary);
            width: 90%;
            max-width: 900px;
            animation: fadeIn 1s ease-out;
            position: relative; 
            margin-bottom: 20px; /* Space for large content */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2, h3 {
            text-align: center;
            color: var(--color-primary);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        /* General Form Styling */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="password"], select, input[type="date"] {
            width: 100%; padding: 12px; border: 2px solid #555; border-radius: 8px; background-color: #2a2a2a; color: var(--color-light); box-sizing: border-box; transition: border-color 0.3s;
        }
        input:focus, select:focus { border-color: var(--color-secondary); outline: none; box-shadow: 0 0 10px rgba(0, 191, 255, 0.5); }
        
        button {
            width: 100%; padding: 15px; background-color: var(--color-primary); color: var(--color-dark); border: none; border-radius: 8px; font-size: 1.05em; font-weight: bold; cursor: pointer; transition: background-color 0.15s, transform 0.15s;
            margin-top: 15px;
        }

        button.secondary {
            width: auto;
            background-color: #444;
            color: var(--color-light);
            box-shadow: none;
            font-size: 1em;
            padding: 10px;
            margin-left: 10px;
        }

        button:hover { background-color: #2ECC40; transform: translateY(-2px); }

        .error-message { color: var(--color-error); font-size: 0.9em; margin-top: 5px; display: none; }
        .alert-message { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; display: none; border: 2px solid; }

        /* --- DASHBOARD STYLING --- */
        #user-dashboard { padding: 20px; border: 2px solid var(--color-secondary); border-radius: 10px; margin-top: 20px; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .dashboard-header h3 { margin: 0; }
        
        .booking-list-item {
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
            background-color: #2a2a2a;
            border-left: 5px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-pending { border-color: var(--color-pending); color: var(--color-dark); background-color: var(--color-pending); }
        .status-confirmed { border-color: var(--color-confirmed); color: var(--color-light); background-color: var(--color-confirmed); }
        .status-declined { border-color: var(--color-declined); color: var(--color-light); background-color: var(--color-declined); }

        /* Admin Specific Styling */
        #admin-actions { margin-top: 15px; display: flex; gap: 10px; }
        #admin-actions button { width: auto; font-size: 0.8em; padding: 5px 10px; margin: 0; }
        .admin-item { border-left-width: 10px; } /* Thicker border for admin view */

        /* Utility classes to show/hide sections */
        .hidden { display: none !important; }
        
        /* Specific Styles from previous version */
        .schedule-info { text-align: center; color: var(--color-secondary); font-weight: bold; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid var(--color-secondary); }
        #cancellation-link { text-align: center; margin-top: 20px; cursor: pointer; text-decoration: underline; color: var(--color-cancel); }
        #cancellation-form-area { margin-top: 20px; padding: 15px; border: 2px solid var(--color-cancel); border-radius: 8px; background-color: rgba(112, 128, 144, 0.1); }
        .cancel-button { background-color: var(--color-cancel); color: white; padding: 10px; margin-top: 10px; }

        /* --- TERMS AGREEMENT VALIDATION / ANIMATION STYLES --- */
        @keyframes shakeX {
            0% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-6px); }
            80% { transform: translateX(6px); }
            100% { transform: translateX(0); }
        }
        .shake {
            animation: shakeX 0.6s cubic-bezier(.36,.07,.19,.97);
        }
        /* Container highlight when error */
        .error-highlight label {
            color: var(--color-error) !important;
        }
        .error-highlight input[type="checkbox"] {
            box-shadow: 0 0 8px rgba(255,69,0,0.9);
            border-radius: 4px;
            outline: 2px solid rgba(255,69,0,0.15);
        }

        /* small forgot link styling */
        .forgot-link { display:block; text-align:center; margin-top:8px; color:var(--color-secondary); text-decoration:underline; cursor:pointer; }
        .info-message { font-size:0.95em; color:#ccc; text-align:center; margin-top:8px; display:none; }

        .spots-info { font-size:0.95em; color:#ddd; margin-top:6px; text-align:center; }
        .full-note { color: var(--color-error); font-weight: bold; }

        .admin-note { margin-top:8px; font-size:0.9em; color:#ccc; }

        .child-details { margin-top:8px; font-size:0.95em; color:#ddd; background:#222; padding:8px; border-radius:6px; }

        .booking-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; }

    </style>
</head>
<body>
    <div class="container" id="app-container">
        <section id="auth-section">
            <h2>Geometry Dash Creator Club</h2>
            <div class="schedule-info" id="schedule-info">
                üìÖ <strong>Club Schedule:</strong> Sessions can be booked for any date.
            </div>
            <h3 style="color: var(--color-light);">Sign In or Sign Up</h3>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">Username:</label>
                    <input type="text" id="login-username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">Log In</button>
                <div class="alert-message" id="login-status" style="border-color: var(--color-error);"></div>

                <!-- Forgot password link -->
                <a href="#" id="forgot-password-link" class="forgot-link" onclick="forgotPassword(); return false;">Forgot Password?</a>
                <div id="forgot-info" class="info-message"></div>
            </form>
            
            <button class="secondary" onclick="showSection('signup-form-section')">New User? Create Account</button>
        </section>

        <section id="signup-form-section" class="hidden">
            <h2>Create Your Club Account</h2>
            <form id="signup-form">
                <div class="form-group">
                    <label for="signup-username">Choose Username <span style="color:var(--color-error);">*</span></label>
                    <input type="text" id="signup-username" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Choose Password <span style="color:var(--color-error);">*</span></label>
                    <input type="password" id="signup-password" required>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email (Required for booking notifications) <span style="color:var(--color-error);">*</span></label>
                    <input type="email" id="signup-email" required>
                </div>

                <!-- TERMS AGREEMENT CHECKBOX -->
                <div class="form-group" id="agree-terms-container" style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                    <label for="agreeTerms" style="margin:0; font-weight:normal;">
                        I agree to the <a href="term.html" target="_blank" rel="noopener noreferrer" style="color:var(--color-secondary); text-decoration:underline;">Terms and Conditions</a>
                    </label>
                    <div class="error-message" id="error-agreeTerms" style="display:none; margin-left:0;">
                        You must agree to the Terms and Conditions to continue.
                    </div>
                </div>

                <button type="submit">Sign Up</button>
                <div class="alert-message" id="signup-status" style="border-color: var(--color-error);"></div>
            </form>
            <button class="secondary" onclick="showSection('auth-section')">Already have an account? Log In</button>
        </section>

        <section id="dashboard-section" class="hidden">
            <div class="dashboard-header">
                <h3 id="welcome-message">Welcome!</h3>
                <div>
                    <button class="secondary" onclick="showSection('booking-form-section')">Book a New Slot</button>
                    <button class="secondary" onclick="logoutUser()">Log Out</button>
                </div>
            </div>
            
            <div id="admin-dashboard" class="hidden">
                <h3 style="color: var(--color-error);">ADMIN VIEW: Pending Bookings</h3>
                <div id="admin-booking-list">
                    <p style="text-align: center;">No bookings currently pending.</p>
                </div>
                <hr style="border-color: #555; margin: 30px 0;"/>
            </div>

            <div id="user-dashboard">
                <h3 id="user-dash-title">Your Recent Bookings</h3>
                <div id="user-booking-list">
                    <p style="text-align: center;">You have no active bookings.</p>
                </div>
                <hr style="border-color: #555; margin: 30px 0;"/>
            </div>
        </section>

        <section id="booking-form-section" class="hidden">
            <h2>Geometry Dash Club Booking</h2>

            <form id="signup-form-app">
                <h3 style="text-align: left; color: var(--color-secondary);">Guardian Details</h3>
                <div class="form-group">
                    <label for="firstName">First Name <span style="color:var(--color-error);">*</span></label>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
                 <div class="form-group">
                    <label for="lastName">Last Name <span style="color:var(--color-error);">*</span></label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number <span style="color:var(--color-error);">*</span></label>
                    <input type="tel" id="phone" name="phone" required pattern="[0-9]{6,15}">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="hasChild" name="hasChild">
                    <label for="hasChild">I am signing up a child/children for the club.</label>
                </div>

                <div id="child-registration-area">
                    <p style="color: var(--color-secondary); font-style: italic;">Child Registration</p>
                    <div class="form-group">
                        <label for="numKids">Number of Kids Signing Up <span style="color:var(--color-error);">*</span></label>
                        <select id="numKids" name="numKids">
                            <option value="1">1 Child</option>
                            <option value="2">2 Children</option>
                            <option value="3">3 Children</option>
                            <option value="4">4 Children</option>
                            <option value="5">5 Children</option>
                        </select>
                    </div>
                    <div id="child-forms-container"></div>
                </div>
                
                <hr style="border-color: #555; margin-top: 30px;"/>

                <div id="date-selection-section">
                    <h3 style="color: var(--color-primary); margin-top: 0; text-align: center;">üìÖ Choose Preferred Date</h3>

                    <div class="form-group">
                        <label for="clubDay">Select Preferred Date <span style="color:var(--color-error);">*</span></label>
                        <input type="date" id="clubDay" name="clubDay" required>
                        <div id="spots-info" class="spots-info" aria-live="polite"></div>
                        <div class="error-message" id="error-clubDay">Please select a valid date.</div>
                        <p style="font-size: 0.85em; color: #888; margin-top: 5px;">You may choose any date. Sessions are limited per date.</p>
                    </div>

                    <div class="date-time-group">
                        <div>
                            <div class="form-group">
                                <label for="dropOffTime">Drop-off Time <span style="color:var(--color-error);">*</span></label>
                                <select id="dropOffTime" name="dropOffTime" required>
                                    <option value="" disabled selected>Select Drop-off</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                </select>
                                <div class="error-message" id="error-dropOffTime">Drop-off time is required.</div>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label for="pickUpTime">Pick-up Time <span style="color:var(--color-error);">*</span></label>
                                <select id="pickUpTime" name="pickUpTime" required>
                                    <option value="" disabled selected>Select Pick-up</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                </select>
                                <div class="error-message" id="error-pickUpTime">Pick-up time is required.</div>
                            </div>
                        </div>
                    </div>
                    
                    <p style="font-size: 0.9em; text-align: center; color: #aaa;">Club session time must be at least one hour long.</p>
                </div>
                
                <hr style="border-color: #555; margin-top: 30px;"/>

                <div class="fee-notice">
                    ‚ö†Ô∏è **Club Fee: $10.00** per child, collected upon drop-off via Square reader.<br>
                    **Pay on drop off/pick up ONLY!**
                </div>
                
                <button type="submit">Complete Club Booking Request</button>

                <div id="result-message" class="alert-message"></div>
                <button class="secondary" type="button" onclick="showSection('dashboard-section')">Back to Dashboard</button>
            </form>
            
        </section>

        <section id="cancellation-form-section" class="hidden">
             <h2>Cancel a Booking</h2>
             <p style="color: var(--color-cancel); font-weight: bold;">To cancel your booking, please confirm the email address used for registration:</p>
            <div class="form-group">
                <label for="cancelEmail">Registration Email Address:</label>
                <input type="email" id="cancelEmail" placeholder="Your Email" required>
            </div>
            <button type="button" class="cancel-button" onclick="initiateCancellation()">Initiate Cancellation Request</button>
            <p id="cancel-status" class="error-message" style="color: var(--color-cancel);"></p>
            <button class="secondary" onclick="showSection('dashboard-section')">Back to Dashboard</button>
        </section>
        
        <div id="gd-app-modal" class="modal-overlay" style="display:none; align-items:center; justify-content:center;">
            <div class="modal-content" style="background:#222; padding:20px; border-radius:8px; max-width:420px; color:var(--color-light);">
                <h3 style="color: var(--color-error);">WAIT! Have you bought the $4.99 Geometry Dash?</h3>
                <p>The full game is required for the Level Creator Club. The free versions are not sufficient.</p>
                <div class="modal-buttons" style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                    <button type="button" class="btn-yes" onclick="handleAppCheck(true)">YES, I Have It!</button>
                    <button type="button" class="btn-no" onclick="handleAppCheck(false)">NO, Not Yet</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- ‚öôÔ∏è JAVASCRIPT AUTHENTICATION, STORAGE, AND LOGIC ---
        
        const ADMIN_USERNAME = "EthanUnlocked";
        const ADMIN_PASSWORD = "CoolGamer67";

        // Maximum spots per session (per date)
        const MAX_SPOTS_PER_DATE = 10;

        // Global variable to hold current user info
        let currentUser = null; 

        const CURRENT_YEAR = new Date().getFullYear();

        // --- UTILS ---
        function getBookings() {
            const bookings = localStorage.getItem('clubBookings');
            return bookings ? JSON.parse(bookings) : [];
        }
        function saveBookings(bookings) {
            localStorage.setItem('clubBookings', JSON.stringify(bookings));
        }
        function getUsers() {
            const users = localStorage.getItem('clubUsers');
            const userList = users ? JSON.parse(users) : [];
            if (!userList.find(u => u.username === ADMIN_USERNAME)) {
                 userList.push({
                    id: 'admin',
                    username: ADMIN_USERNAME,
                    password: ADMIN_PASSWORD,
                    email: 'ethan.ioannou@icloud.com',
                    is_admin: true,
                    firstName: 'Ethan',
                    lastName: 'Admin'
                });
                localStorage.setItem('clubUsers', JSON.stringify(userList));
            }
            return userList;
        }

        function formatTime(timeValue) {
            if (!timeValue) return '';
            const hour = parseInt(timeValue.split(':')[0], 10);
            if (hour === 12) return "12:00 PM";
            if (hour === 0) return "12:00 AM";
            if (hour < 12) return `${hour}:00 AM`;
            return `${hour - 12}:00 PM`;
        }
        function formatDateISO(iso) {
            if (!iso) return '';
            const d = new Date(iso + 'T00:00:00');
            return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }
        function escapeHtml(s) {
            if (!s) return '';
            return s.replace(/[&<>"']/g, function(m) {
                return ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' })[m];
            });
        }

        // spots functions
        function spotsReservedForDate(dateISO, excludeBookingId) {
            const bookings = getBookings();
            let reserved = 0;
            bookings.forEach(b => {
                if (!b || !b.preferredDay) return;
                if (b.preferredDay === dateISO && b.status !== 'Declined') {
                    if (excludeBookingId && b.id === excludeBookingId) return;
                    reserved += Number(b.numKids || 0);
                }
            });
            return reserved;
        }
        function spotsRemainingForDate(dateISO, excludeBookingId) {
            const reserved = spotsReservedForDate(dateISO, excludeBookingId);
            return Math.max(0, MAX_SPOTS_PER_DATE - reserved);
        }
        function updateSpotsInfo(dateISO) {
            const spotsEl = document.getElementById('spots-info');
            if (!spotsEl) return;
            if (!dateISO) {
                spotsEl.innerHTML = '';
                return;
            }
            const remaining = spotsRemainingForDate(dateISO);
            if (remaining === 0) {
                spotsEl.innerHTML = `<span class="full-note">This date is FULL (0 spots remaining).</span>`;
            } else {
                spotsEl.innerHTML = `Spots remaining for ${formatDateISO(dateISO)}: <strong>${remaining}</strong> / ${MAX_SPOTS_PER_DATE}`;
            }
        }

        // child form helpers
        function createChildFormHTML(index) {
            return `
                <div class="child-form" data-child-index="${index}">
                    <div class="child-form-header">Child #${index} Details</div>
                    <div class="form-group">
                        <div style="flex: 2;">
                            <label for="childFirstName${index}">Child First Name <span style="color:var(--color-error);">*</span></label>
                            <input type="text" id="childFirstName${index}" name="childFirstName${index}" required data-field-name="First Name">
                            <div class="error-message" id="error-childFirstName${index}" style="display:none;">Please enter the child's first name.</div>
                        </div>
                        <div style="flex: 1;">
                            <label for="childAge${index}">Age <span style="color:var(--color-error);">*</span></label>
                            <input type="number" id="childAge${index}" name="childAge${index}" min="1" max="99" required data-field-name="Age">
                        </div>
                        <div style="flex: 1;">
                            <label for="childBirthYear${index}">Birth Year <span style="color:var(--color-error);">*</span></label>
                            <input type="number" id="childBirthYear${index}" name="childBirthYear${index}" min="1900" max="${CURRENT_YEAR}" required data-field-name="Birth Year">
                        </div>
                    </div>
                </div>
            `;
        }
        function generateChildForms(count) {
            const childFormsContainer = document.getElementById('child-forms-container');
            if (!childFormsContainer) return;
            childFormsContainer.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                childFormsContainer.insertAdjacentHTML('beforeend', createChildFormHTML(i));
            }
        }

        // --- Auth handlers ---
        function checkAuth() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showDashboard();
            } else {
                showSection('auth-section');
            }
        }

        window.loginUser = function(e) {
            e.preventDefault();
            const usernameInput = document.getElementById('login-username').value;
            const passwordInput = document.getElementById('login-password').value;
            const statusDiv = document.getElementById('login-status');
            if (statusDiv) statusDiv.style.display = 'none';

            const users = getUsers();
            const user = users.find(u => u.username === usernameInput && u.password === passwordInput);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showDashboard();
            } else {
                if (statusDiv) {
                    statusDiv.innerText = "Invalid username or password.";
                    statusDiv.style.display = 'block';
                }
            }
        };

        window.forgotPassword = function() {
            const identifier = prompt("Enter your username or registration email to reset your password:");
            if (!identifier) return;

            const users = getUsers();
            const statusDiv = document.getElementById('login-status');
            if (statusDiv) statusDiv.style.display = 'none';

            const found = users.find(u => (u.username && u.username.toLowerCase() === identifier.toLowerCase()) || (u.email && u.email.toLowerCase() === identifier.toLowerCase()));
            if (found) {
                const coordinatorEmail = "ethan.ioannou@icloud.com";
                const subject = encodeURIComponent(`Password reset request for ${found.username}`);
                const body = encodeURIComponent(`Hello Ethan,\n\nPlease assist with resetting the password for the following account:\n\nUsername: ${found.username}\nEmail: ${found.email}\n\nThank you.`);
                const mailtoLink = `mailto:${coordinatorEmail}?subject=${subject}&body=${body}`;
                window.open(mailtoLink, '_blank');

                if (statusDiv) {
                    statusDiv.innerText = "A password reset request has been opened in your mail client. Follow the email to complete the reset.";
                    statusDiv.style.display = 'block';
                }
            } else {
                if (statusDiv) {
                    statusDiv.innerText = "No account found for that username or email.";
                    statusDiv.style.display = 'block';
                }
            }
        };

        window.signupUser = function(e) {
            e.preventDefault();
            const agreeCheckbox = document.getElementById('agreeTerms');
            const agreeContainer = document.getElementById('agree-terms-container');
            const agreeError = document.getElementById('error-agreeTerms');
            if (!agreeCheckbox || !agreeCheckbox.checked) {
                if (agreeContainer) {
                    agreeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    agreeContainer.classList.remove('shake', 'error-highlight');
                    void agreeContainer.offsetWidth;
                    agreeContainer.classList.add('shake', 'error-highlight');
                }
                if (agreeError) agreeError.style.display = 'block';
                if (agreeCheckbox) agreeCheckbox.focus();
                return;
            } else {
                if (agreeContainer) agreeContainer.classList.remove('shake', 'error-highlight');
                if (agreeError) agreeError.style.display = 'none';
            }

            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value;
            const email = document.getElementById('signup-email').value.trim();
            const statusDiv = document.getElementById('signup-status');
            if (statusDiv) statusDiv.style.display = 'none';

            if (!username || !password || !email) {
                if (statusDiv) {
                    statusDiv.innerText = "Please complete all required fields.";
                    statusDiv.style.display = 'block';
                }
                return;
            }

            const users = getUsers();
            if (users.find(u => u.username === username)) {
                if (statusDiv) {
                    statusDiv.innerText = "Username already exists.";
                    statusDiv.style.display = 'block';
                }
                return;
            }

            const newUser = {
                id: Date.now().toString(),
                username: username,
                password: password,
                email: email,
                is_admin: false,
                firstName: '',
                lastName: ''
            };

            users.push(newUser);
            localStorage.setItem('clubUsers', JSON.stringify(users));

            currentUser = newUser;
            localStorage.setItem('currentUser', JSON.stringify(newUser));
            showDashboard();
        };

        window.logoutUser = function() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showSection('auth-section');
            const lu = document.getElementById('login-username');
            const lp = document.getElementById('login-password');
            if (lu) lu.value = '';
            if (lp) lp.value = '';
        };

        // --- Dashboard & Rendering ---
        function showDashboard() {
            if (!currentUser) return;
            const welcome = document.getElementById('welcome-message');
            if (welcome) welcome.innerText = `Welcome, ${currentUser.username}!`;
            showSection('dashboard-section');

            if (currentUser.is_admin) {
                const adminDash = document.getElementById('admin-dashboard');
                if (adminDash) adminDash.classList.remove('hidden');
                const title = document.getElementById('user-dash-title');
                if (title) title.innerText = 'Your Admin Bookings';
                renderAdminBookings();
            } else {
                const adminDash = document.getElementById('admin-dashboard');
                if (adminDash) adminDash.classList.add('hidden');
                const title = document.getElementById('user-dash-title');
                if (title) title.innerText = 'Your Recent Bookings';
            }
            renderUserBookings();
        }

        function renderUserBookings() {
            const bookings = getBookings();
            if (!currentUser) return;
            const userBookings = bookings.filter(b => b.userId === currentUser.id);
            const listContainer = document.getElementById('user-booking-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';

            if (userBookings.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #aaa;">You have no active bookings.</p>';
                return;
            }

            userBookings.forEach(booking => {
                const statusClass = `status-${booking.status.toLowerCase()}`;
                const childCount = Number(booking.numKids || 0);
                const childToggleId = `child-details-${booking.id}`;
                const repliesHtml = (booking.replies && booking.replies.length)
                    ? `<div style="margin-top:8px; font-size:0.9em; color:#ccc;">Replies:<br>${booking.replies.map(r => `<div style="margin-top:6px;">${escapeHtml(r.from)} (${new Date(r.created_at).toLocaleString()}): ${escapeHtml(r.text)}</div>`).join('')}</div>`
                    : '';
                const adminReplyBtn = booking.adminAllowReply ? `<button class="secondary" onclick="replyToAdmin('${booking.id}')">Reply to Admin</button>` : '';
                const copyBtn = `<button class="secondary" onclick="copyBooking('${booking.id}')">Copy Booking</button>`;
                const phoneAndEmail = `<div style="margin-top:6px; font-size:0.9em; color:#bbb;">Contact: ${escapeHtml(booking.parentEmail || '')} ‚Ä¢ ${escapeHtml(booking.phone || '')}</div>`;
                const childDetailsHtml = (booking.children && booking.children.length > 0)
                    ? booking.children.map((c, idx) => `<div>Child ${idx+1}: ${escapeHtml(c.firstName)} ‚Äî Age: ${escapeHtml(String(c.age))} ‚Äî Birth Year: ${escapeHtml(String(c.birthYear))}</div>`).join('')
                    : '<div>No child details recorded.</div>';

                const html = `
                    <div class="booking-list-item" style="border-left-color: var(--color-${booking.status.toLowerCase()});">
                        <div style="max-width:72%;">
                            <div><strong>Date:</strong> ${formatDateISO(booking.preferredDay)}</div>
                            <div><strong>Time:</strong> ${formatTime(booking.dropOffTime)} - ${formatTime(booking.pickUpTime)}</div>
                            <div><strong>Children:</strong> <a href="#" onclick="toggleChildDetails('${childToggleId}'); return false;" style="color:var(--color-secondary);">${childCount}</a></div>
                            <div id="${childToggleId}" class="child-details hidden">${childDetailsHtml}</div>
                            ${booking.adminNote ? `<div class="admin-note">Admin note: ${escapeHtml(booking.adminNote)}</div>` : ''}
                            ${phoneAndEmail}
                            ${repliesHtml}
                        </div>
                        <div class="booking-actions">
                            <span class="status-badge ${statusClass}" style="margin-right:8px;">${booking.status.toUpperCase()}</span>
                            ${adminReplyBtn}
                            ${copyBtn}
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        function toggleChildDetails(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.classList.toggle('hidden');
            if (!el.classList.contains('hidden')) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function renderAdminBookings() {
            const bookings = getBookings();
            const pendingBookings = bookings.filter(b => b.status === 'Pending');
            const listContainer = document.getElementById('admin-booking-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';

            if (pendingBookings.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #aaa;">No bookings currently pending.</p>';
                return;
            }

            // show current spots summary per date at the top for admin
            const grouped = {};
            bookings.forEach(b => {
                if (!grouped[b.preferredDay]) grouped[b.preferredDay] = 0;
                grouped[b.preferredDay] += Number(b.numKids || 0);
            });

            let summaryHtml = '<div style="margin-bottom:10px; font-size:0.95em; color:#ccc;">Current spots used by date: ';
            summaryHtml += Object.keys(grouped).map(d => `${formatDateISO(d)}: ${grouped[d]}/${MAX_SPOTS_PER_DATE}`).join(' ‚Ä¢ ');
            summaryHtml += '</div>';
            listContainer.insertAdjacentHTML('beforeend', summaryHtml);

            pendingBookings.forEach(booking => {
                const childList = (booking.children && booking.children.length > 0) ? booking.children.map(c => escapeHtml(c.firstName)).join(', ') : 'N/A';
                const repliesHtml = (booking.replies && booking.replies.length)
                    ? `<div style="margin-top:8px; font-size:0.9em; color:#ccc;">Replies:<br>${booking.replies.map(r => `<div style="margin-top:6px;">${escapeHtml(r.from)} (${new Date(r.created_at).toLocaleString()}): ${escapeHtml(r.text)}</div>`).join('')}</div>`
                    : '';
                const html = `
                    <div class="booking-list-item admin-item" style="border-left-color: var(--color-pending);">
                        <div style="flex-grow: 1;">
                            <div><strong>User:</strong> ${booking.username} | <strong>Kids:</strong> ${booking.numKids}</div>
                            <div><strong>Date:</strong> ${formatDateISO(booking.preferredDay)} | <strong>Time:</strong> ${formatTime(booking.dropOffTime)} - ${formatTime(booking.pickUpTime)}</div>
                            <div><strong>Email:</strong> ${escapeHtml(booking.parentEmail || '')} | <strong>Phone:</strong> ${escapeHtml(booking.phone || '')}</div>
                            <div class="admin-note">Child names: ${childList}</div>
                            ${booking.adminNote ? `<div class="admin-note">Previous admin note: ${escapeHtml(booking.adminNote)}</div>` : ''}
                            ${repliesHtml}
                        </div>
                        <div id="admin-actions">
                            <button onclick="adminRespond('${booking.id}', 'Confirmed')">Confirm</button>
                            <button onclick="adminRespond('${booking.id}', 'Declined')">Decline</button>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // Admin respond flow includes an option to allow replies from the user
        window.adminRespond = function(bookingId, newStatus) {
            const bookings = getBookings();
            const idx = bookings.findIndex(b => b.id === bookingId);
            if (idx === -1) return alert('Booking not found.');
            const booking = bookings[idx];

            if (newStatus === 'Confirmed') {
                const remaining = spotsRemainingForDate(booking.preferredDay, booking.id);
                if (Number(booking.numKids || 0) > remaining) {
                    return alert(`Cannot confirm: Not enough spots left on ${formatDateISO(booking.preferredDay)}. Current spots available: ${remaining}. Please decline or ask user to reduce spots or pick another date.`);
                }
            }

            const promptText = newStatus === 'Confirmed'
                ? 'Optional: Enter a confirmation message or note to send to the parent (or leave blank):'
                : 'Optional: Enter a reason for decline to send to the parent (or leave blank):';

            const note = prompt(promptText, booking.adminNote || '');

            // Ask whether to allow replies from the user about this note
            const allowReply = confirm('Allow the person who booked to reply to this admin message? (OK = allow, Cancel = do not allow)');

            bookings[idx].status = newStatus;
            bookings[idx].adminNote = note ? String(note).trim() : '';
            bookings[idx].adminAllowReply = !!allowReply;

            // initialize replies array if not present
            if (!Array.isArray(bookings[idx].replies)) bookings[idx].replies = [];

            saveBookings(bookings);
            renderAdminBookings();
            renderUserBookings();

            // send mailto to parent
            const recipient = bookings[idx].parentEmail || '';
            const subject = encodeURIComponent(`Geometry Dash Club Booking ${newStatus}: ${formatDateISO(bookings[idx].preferredDay)}`);
            const bodyLines = [];
            if (newStatus === 'Confirmed') {
                bodyLines.push(`Hello ${bookings[idx].parentName},`);
                bodyLines.push('');
                bodyLines.push(`Your booking for ${formatDateISO(bookings[idx].preferredDay)} has been CONFIRMED.`);
                bodyLines.push(`Time: ${formatTime(bookings[idx].dropOffTime)} - ${formatTime(bookings[idx].pickUpTime)}`);
                bodyLines.push(`Children booked: ${bookings[idx].numKids}`);
                bodyLines.push('');
                if (bookings[idx].adminNote) bodyLines.push(`Message from coordinator: ${bookings[idx].adminNote}`);
                bodyLines.push('');
                bodyLines.push(`You ${bookings[idx].adminAllowReply ? 'may' : 'may NOT'} reply to this message through the booking page.`);
                bodyLines.push('');
                bodyLines.push('Regards,');
                bodyLines.push('Geometry Dash Club Coordinator');
            } else {
                bodyLines.push(`Hello ${bookings[idx].parentName},`);
                bodyLines.push('');
                bodyLines.push(`We are sorry to inform you that your booking for ${formatDateISO(bookings[idx].preferredDay)} has been DECLINED.`);
                if (bookings[idx].adminNote) {
                    bodyLines.push('');
                    bodyLines.push(`Reason: ${bookings[idx].adminNote}`);
                } else {
                    bodyLines.push('');
                    bodyLines.push('Please contact the coordinator for more details.');
                }
                bodyLines.push('');
                bodyLines.push(`You ${bookings[idx].adminAllowReply ? 'may' : 'may NOT'} reply to this message through the booking page.`);
                bodyLines.push('');
                bodyLines.push('Regards,');
                bodyLines.push('Geometry Dash Club Coordinator');
            }

            const body = encodeURIComponent(bodyLines.join('\n'));
            if (recipient) {
                const mailto = `mailto:${recipient}?subject=${subject}&body=${body}`;
                window.open(mailto, '_blank');
            } else {
                alert('No parent email on file to notify.');
            }

            updateSpotsInfo(booking.preferredDay);
        };

        // Reply from user to admin about a booking
        window.replyToAdmin = function(bookingId) {
            if (!currentUser) return alert('You must be signed in to reply.');
            const bookings = getBookings();
            const idx = bookings.findIndex(b => b.id === bookingId);
            if (idx === -1) return alert('Booking not found.');
            const booking = bookings[idx];
            if (!booking.adminAllowReply) return alert('Replies are not allowed for this admin message.');

            const reply = prompt('Enter your reply to the admin:');
            if (!reply || !reply.trim()) return;

            if (!Array.isArray(booking.replies)) booking.replies = [];
            booking.replies.push({
                from: currentUser.username,
                text: reply.trim(),
                created_at: new Date().toISOString()
            });

            saveBookings(bookings);
            renderUserBookings();
            renderAdminBookings();

            // Optionally open mailto to admin for immediate contact
            const coordinatorEmail = 'ethan.unlocked@gmail.com';
            const subject = encodeURIComponent(`Reply to admin about booking ${booking.id}`);
            const body = encodeURIComponent(`User ${currentUser.username} replied regarding booking ${booking.id}:\n\n${reply.trim()}`);
            window.open(`mailto:${coordinatorEmail}?subject=${subject}&body=${body}`, '_blank');
            alert('Your reply was saved and an email draft to the coordinator has been opened.');
        };

        // copy booking into form so user can quickly re-book same details
        function copyBooking(bookingId) {
            const bookings = getBookings();
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return alert('Booking not found.');

            showSection('booking-form-section');

            const fn = document.getElementById('firstName');
            const ln = document.getElementById('lastName');
            const phone = document.getElementById('phone');
            const clubDay = document.getElementById('clubDay');
            const dropOff = document.getElementById('dropOffTime');
            const pickUp = document.getElementById('pickUpTime');
            const hasChild = document.getElementById('hasChild');
            const numKids = document.getElementById('numKids');

            if (fn) fn.value = (booking.parentName || '').split(' ')[0] || '';
            if (ln) ln.value = (booking.parentName || '').split(' ').slice(1).join(' ') || '';
            if (phone) phone.value = booking.phone || '';
            if (clubDay) clubDay.value = booking.preferredDay || '';
            if (dropOff) dropOff.value = booking.dropOffTime || '';
            if (pickUp) pickUp.value = booking.pickUpTime || '';

            if (booking.children && booking.children.length > 0) {
                if (hasChild) hasChild.checked = true;
                if (numKids) numKids.value = String(booking.children.length);
                generateChildForms(booking.children.length);
                booking.children.forEach((c, idx) => {
                    const i = idx + 1;
                    const fnc = document.getElementById(`childFirstName${i}`);
                    const agec = document.getElementById(`childAge${i}`);
                    const yrc = document.getElementById(`childBirthYear${i}`);
                    if (fnc) fnc.value = c.firstName || '';
                    if (agec) agec.value = c.age || '';
                    if (yrc) yrc.value = c.birthYear || '';
                });
            } else {
                if (hasChild) hasChild.checked = false;
                if (numKids) numKids.value = '1';
                const childFormsContainer = document.getElementById('child-forms-container');
                if (childFormsContainer) childFormsContainer.innerHTML = '';
            }

            updateSpotsInfo(clubDay ? clubDay.value : '');
            document.getElementById('signup-form-app').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // collect children from current booking form
        function collectChildrenFromForm() {
            const children = [];
            const hasChild = document.getElementById('hasChild');
            if (!hasChild || !hasChild.checked) return children;
            const num = parseInt(document.getElementById('numKids').value || '0', 10) || 0;
            for (let i = 1; i <= num; i++) {
                const firstNameEl = document.getElementById(`childFirstName${i}`);
                const ageEl = document.getElementById(`childAge${i}`);
                const yearEl = document.getElementById(`childBirthYear${i}`);
                if (firstNameEl) {
                    children.push({
                        firstName: firstNameEl.value.trim(),
                        age: ageEl ? ageEl.value : '',
                        birthYear: yearEl ? yearEl.value : ''
                    });
                }
            }
            return children;
        }

        // --- Booking submission & validation ---
        function validateForm() {
            let isValid = true;
            let firstInvalidField = null;
            document.querySelectorAll('#booking-form-section .error-message').forEach(el => el.style.display = 'none');
            const resultMsg = document.getElementById('result-message');
            if (resultMsg) resultMsg.style.display = 'none';

            const requiredFields = ['firstName', 'lastName', 'phone', 'clubDay', 'dropOffTime', 'pickUpTime'];
            requiredFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (!input || input.value.trim() === '' || (input.tagName === 'SELECT' && input.value === '')) {
                    const err = document.getElementById(`error-${fieldId}`);
                    if (err) err.style.display = 'block';
                    if (input) input.style.borderColor = 'var(--color-error)';
                    if (!firstInvalidField) firstInvalidField = input;
                    isValid = false;
                }
            });

            // check clubDay is a valid date string
            const selectedDay = document.getElementById('clubDay').value;
            if (!/^\d{4}-\d{2}-\d{2}$/.test(selectedDay)) {
                const err = document.getElementById('error-clubDay');
                if (err) err.style.display = 'block';
                if (!firstInvalidField) firstInvalidField = document.getElementById('clubDay');
                isValid = false;
            }

            const dropOffValue = document.getElementById('dropOffTime').value;
            const pickUpValue = document.getElementById('pickUpTime').value;
            const timeErrorElement = document.getElementById('error-pickUpTime');

            if (dropOffValue !== '' && pickUpValue !== '') {
                const dropOffHour = parseInt(dropOffValue.split(':')[0], 10);
                const pickUpHour = parseInt(pickUpValue.split(':')[0], 10);
                if (pickUpHour <= dropOffHour) {
                    if (timeErrorElement) {
                        timeErrorElement.innerText = "Pick-up time must be after the drop-off time (minimum 1 hour session).";
                        timeErrorElement.style.display = 'block';
                    }
                    const pickUpEl = document.getElementById('pickUpTime');
                    if (pickUpEl) pickUpEl.style.borderColor = 'var(--color-error)';
                    if (!firstInvalidField) firstInvalidField = document.getElementById('pickUpTime');
                    isValid = false;
                } else {
                    if (timeErrorElement) timeErrorElement.innerText = "Pick-up time is required.";
                }
            }

            const hasChildCheckbox = document.getElementById('hasChild');
            if (hasChildCheckbox && hasChildCheckbox.checked) {
                const numKids = parseInt(document.getElementById('numKids').value, 10) || 0;
                for (let i = 1; i <= numKids; i++) {
                    const nameInput = document.getElementById(`childFirstName${i}`);
                    if (nameInput && nameInput.value.trim() === '') {
                        const err = document.getElementById(`error-childFirstName${i}`);
                        if (err) err.style.display = 'block';
                        nameInput.style.borderColor = 'var(--color-error)';
                        if (!firstInvalidField) firstInvalidField = nameInput;
                        isValid = false;
                    }
                }
            }

            if (firstInvalidField) {
                firstInvalidField.focus();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return isValid;
        }

        function submitBooking() {
            const data = getBookingData();
            if (!currentUser) {
                alert('You must be signed in to make a booking.');
                showSection('auth-section');
                return;
            }

            const requested = Number(data.numKids || 0);
            const remaining = spotsRemainingForDate(data.preferredDay);
            if (requested > remaining) {
                const resultEl = document.getElementById('result-message');
                const msg = `Sorry, there is not enough room. Current spot count: ${remaining}. Please try booking ${remaining} or fewer spots, or pick a different date.`;
                if (resultEl) {
                    resultEl.innerHTML = `<p class="full-note">üõë ${msg}</p>`;
                    resultEl.style.display = 'block';
                } else {
                    alert(msg);
                }
                updateSpotsInfo(data.preferredDay);
                return;
            }

            if (!currentUser.firstName && data.firstName) {
                currentUser.firstName = data.firstName;
                currentUser.lastName = data.lastName;
                let users = getUsers();
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex > -1) {
                    users[userIndex].firstName = data.firstName;
                    users[userIndex].lastName = data.lastName;
                    localStorage.setItem('clubUsers', JSON.stringify(users));
                }
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }

            const children = collectChildrenFromForm();

            const newBooking = {
                id: 'BOOK-' + Date.now(),
                userId: currentUser.id,
                username: currentUser.username,
                parentName: `${data.firstName} ${data.lastName}`,
                parentEmail: currentUser.email || '',
                phone: data.phone,
                preferredDay: data.preferredDay,
                dropOffTime: data.dropOffTime,
                pickUpTime: data.pickUpTime,
                numKids: Number(data.numKids || 0),
                children: children,
                status: 'Pending',
                adminNote: '',
                adminAllowReply: false,
                replies: [],
                created_at: new Date().toISOString()
            };

            const bookings = getBookings();
            bookings.push(newBooking);
            saveBookings(bookings);

            displayFinalSuccess(data, newBooking.id);
            renderUserBookings();
            if (currentUser.is_admin) renderAdminBookings();
            updateSpotsInfo(newBooking.preferredDay);
        }

        function getBookingData() {
            const form = document.getElementById('signup-form-app');
            const data = {};
            data.firstName = form.querySelector('#firstName').value.trim();
            data.lastName = form.querySelector('#lastName').value.trim();
            data.phone = form.querySelector('#phone').value.trim();
            data.preferredDay = form.querySelector('#clubDay').value;
            data.dropOffTime = form.querySelector('#dropOffTime').value;
            data.pickUpTime = form.querySelector('#pickUpTime').value;
            data.numKids = document.getElementById('hasChild').checked ? parseInt(document.getElementById('numKids').value, 10) : 0;
            return data;
        }

        function displayFinalSuccess(data, bookingId) {
            const subject = encodeURIComponent(`NEW BOOKING REQUEST: ${data.preferredDay} (${bookingId})`);
            let bodyText = `Hello Ethan,

A new booking request has been submitted by ${data.firstName} ${data.lastName}.

Parent Details:
Email: ${currentUser.email || ''}
Phone: ${data.phone}

Booking Request:
Date: ${formatDateISO(data.preferredDay)}
Time Slot: ${formatTime(data.dropOffTime)} - ${formatTime(data.pickUpTime)}
Children: ${data.numKids}
Status: PENDING - Check Admin Dashboard to Confirm/Decline.

FEE STATUS: $10.00 per child, per session.
`;
            const mailtoLink = `mailto:ethan.ioannou@icloud.com?subject=${subject}&body=${encodeURIComponent(bodyText)}`;

            const resultEl = document.getElementById('result-message');
            if (resultEl) {
                resultEl.innerHTML = `
                    <p>‚úÖ <strong>REQUEST SUBMITTED! Booking ID: ${bookingId}</strong></p>
                    <p>Thank you, <strong>${data.firstName}</strong>. Your request for <strong>${formatDateISO(data.preferredDay)}</strong> is <strong>PENDING</strong> confirmation.</p>
                    <p style="color: var(--color-error); font-weight: bold; margin-top: 15px;">The coordinator will contact you to confirm the exact details and secure your slot.</p>
                    <p>Click the button below to notify the coordinator (This sends the official request):</p>
                    <a href="${mailtoLink}" target="_blank" style="display:block; margin-top:15px; padding:10px; background-color:var(--color-secondary); color:white; border-radius:5px; text-decoration:none; text-align:center;">
                        Click to Send Coordinator Notification
                    </a>
                `;
                resultEl.className = "alert-message alert-success";
                resultEl.style.border = '2px solid var(--color-primary)';
                resultEl.style.color = 'var(--color-light)';
                resultEl.style.display = 'block';
                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function displayFinalFailure() {
            const data = getBookingData();
            const resultEl = document.getElementById('result-message');
            if (resultEl) {
                resultEl.innerHTML = `
                    <p>üõë <strong>BOOKING BLOCKED: APP REQUIRED</strong></p>
                    <p style="font-weight: bold; color: var(--color-error);">Sorry, the $4.99 Geometry Dash app is required! The app is not provided at the club.</p>
                    <p>Please purchase the full game and then re-submit the form once you have the app ready for a <strong>${formatDateISO(data.preferredDay)}</strong> session.</p>
                `;
                resultEl.className = "alert-message alert-fail";
                resultEl.style.border = '2px solid var(--color-error)';
                resultEl.style.color = 'var(--color-error)';
                resultEl.style.display = 'block';
                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // cancellation helper
        window.initiateCancellation = function() {
            const cancelEmailInput = document.getElementById('cancelEmail');
            const statusElement = document.getElementById('cancel-status');
            const coordinatorEmail = "ethan.unlocked@gmail.com";
            const email = cancelEmailInput ? cancelEmailInput.value.trim() : '';

            if (statusElement) statusElement.style.display = 'none';
            if (!email) {
                if (statusElement) {
                    statusElement.innerText = "Please enter your registration email address.";
                    statusElement.style.display = 'block';
                }
                return;
            }

            const subject = encodeURIComponent("CANCELLATION REQUEST: Geometry Dash Level Creator Club");
            const body = encodeURIComponent(`Dear Ethan,

I wish to formally cancel my booking for the Geometry Dash Level Creator Club.

Registration Email: ${email}

Please confirm the cancellation and any next steps.

Thank you.`);
            const cancelMailtoLink = `mailto:${coordinatorEmail}?subject=${subject}&body=${body}`;

            const sect = document.getElementById('cancellation-form-section');
            if (sect) {
                sect.innerHTML = `
                    <h2>Cancel a Booking</h2>
                    <p style="color: var(--color-cancel); font-weight: bold;">
                        Confirmation Required! Your cancellation request is ready.
                    </p>
                    <p>Click the button below to send the formal cancellation email to the club coordinator.</p>
                    <a href="${cancelMailtoLink}" target="_blank" style="display:block; margin-top:15px; padding:10px; background-color:var(--color-cancel); color:white; border-radius:5px; text-decoration:none; text-align:center;">
                        SEND CANCELLATION EMAIL
                    </a>
                    <p style="margin-top: 10px; font-size: 0.9em; text-align: center;">You must send this email to complete the cancellation process.</p>
                    <button class="secondary" onclick="showSection('dashboard-section')">Back to Dashboard</button>
                `;
            }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // populate basic listeners
            const clubDay = document.getElementById('clubDay');
            if (clubDay) {
                clubDay.addEventListener('change', () => updateSpotsInfo(clubDay.value));
            }

            const loginForm = document.getElementById('login-form');
            if (loginForm) loginForm.addEventListener('submit', loginUser);

            const signupForm = document.getElementById('signup-form');
            if (signupForm) signupForm.addEventListener('submit', signupUser);

            const bookingForm = document.getElementById('signup-form-app');
            if (bookingForm) bookingForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (validateForm()) {
                    const modal = document.getElementById('gd-app-modal');
                    if (modal) modal.style.display = 'flex';
                }
            });

            const hasChildCheckbox = document.getElementById('hasChild');
            const childRegistrationArea = document.getElementById('child-registration-area');
            const numKidsSelect = document.getElementById('numKids');

            if (hasChildCheckbox) {
                hasChildCheckbox.addEventListener('change', () => {
                    if (hasChildCheckbox.checked) {
                        if (childRegistrationArea) childRegistrationArea.classList.add('visible');
                        if (numKidsSelect) generateChildForms(parseInt(numKidsSelect.value, 10)); 
                    } else {
                        if (childRegistrationArea) childRegistrationArea.classList.remove('visible');
                        const childFormsContainer = document.getElementById('child-forms-container');
                        if (childFormsContainer) childFormsContainer.innerHTML = '';
                    }
                });
            }

            if (numKidsSelect) {
                numKidsSelect.addEventListener('change', (e) => {
                    if (hasChildCheckbox && hasChildCheckbox.checked) {
                        generateChildForms(parseInt(e.target.value, 10));
                    }
                });
            }

            const signupAgreeCheckbox = document.getElementById('agreeTerms');
            if (signupAgreeCheckbox) {
                signupAgreeCheckbox.addEventListener('change', function() {
                    const container = document.getElementById('agree-terms-container');
                    const agreeError = document.getElementById('error-agreeTerms');
                    if (this.checked) {
                        if (container) container.classList.remove('shake', 'error-highlight');
                        if (agreeError) agreeError.style.display = 'none';
                    }
                });
            }

            // initial spots info empty
            updateSpotsInfo('');

            // show dashboard if logged in
            checkAuth();
        });
    </script>
</body>
</html>
